<!doctypehtml><html lang="en"><meta charset="UTF-8"><title>Yaksha Programming Language</title><link rel="apple-touch-icon"sizes="180x180"href="/apple-touch-icon.png"><link rel="icon"type="image/png"sizes="32x32"href="/favicon-32x32.png"><link rel="icon"type="image/png"sizes="16x16"href="/favicon-16x16.png"><link rel="manifest"href="/site.webmanifest"><link rel="mask-icon"href="/safari-pinned-tab.svg"color="#5bbad5"><meta name="msapplication-TileColor"content="#ffc7fd"><meta name="theme-color"content="#ffffff"><meta name="description"content="Yaksha Programming Language"><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="preconnect"href="https://fonts.googleapis.com"><link rel="preconnect"href="https://fonts.gstatic.com"crossorigin><link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400&family=Source+Code+Pro:wght@400;600;900&family=Ubuntu&display=swap"rel="stylesheet"><link rel="stylesheet"href="/assets/normalize.min.css"><link rel="stylesheet"href="/assets/medium-font.min.css"id="font-size-link"><link rel="stylesheet"href="/assets/style.light.min.css"id="theme-link"><link rel="stylesheet"href="/assets/printing.min.css"media="print"><div class="container"><div class="table-of-contents"><img id="yaksha-logo"alt="Yaksha Programming Language"src="images/yk-banner.png"style="max-width:100%;display:none"><p id="pages-text-toc">Pages<nav><a href="/">Home</a> <a href="/library-docs.html">Lib</a> <a href="/documentation.html">Docs</a> <a href="/tutorials.html">Tutorials</a> <a href="/demos.html">Demos</a> <a href="/yama.html">YAMA</a> <a href="/blog.html">(B)log</a></nav><button id="btn-toggle"class="button action-button"><svg xmlns="http://www.w3.org/2000/svg"width="32"height="32"fill="currentColor"class="bi bi-brightness-high"viewBox="0 0 16 16"><path d="M8 11a3 3 0 1 1 0-6 3 3 0 0 1 0 6zm0 1a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"/></svg></button> <button id="btn-small-font"class="button action-button"><svg xmlns="http://www.w3.org/2000/svg"width="32"height="32"fill="currentColor"class="bi bi-fonts"viewBox="0 0 32 32"><path d="M12.258 3h-8.51l-.083 2.46h.479c.26-1.544.758-1.783 2.693-1.845l.424-.013v7.827c0 .663-.144.82-1.3.923v.52h4.082v-.52c-1.162-.103-1.306-.26-1.306-.923V3.602l.431.013c1.934.062 2.434.301 2.693 1.846h.479L12.258 3z"/></svg></button> <button id="btn-medium-font"class="button action-button"><svg xmlns="http://www.w3.org/2000/svg"width="32"height="32"fill="currentColor"class="bi bi-fonts"viewBox="0 0 24 24"><path d="M12.258 3h-8.51l-.083 2.46h.479c.26-1.544.758-1.783 2.693-1.845l.424-.013v7.827c0 .663-.144.82-1.3.923v.52h4.082v-.52c-1.162-.103-1.306-.26-1.306-.923V3.602l.431.013c1.934.062 2.434.301 2.693 1.846h.479L12.258 3z"/></svg></button> <button id="btn-large-font"class="button action-button"><svg xmlns="http://www.w3.org/2000/svg"width="32"height="32"fill="currentColor"class="bi bi-fonts"viewBox="0 0 16 16"><path d="M12.258 3h-8.51l-.083 2.46h.479c.26-1.544.758-1.783 2.693-1.845l.424-.013v7.827c0 .663-.144.82-1.3.923v.52h4.082v-.52c-1.162-.103-1.306-.26-1.306-.923V3.602l.431.013c1.934.062 2.434.301 2.693 1.846h.479L12.258 3z"/></svg></button><div>&nbsp;</div><div class="real-toc"><div>&nbsp;</div><p>Table of Contents<div class="toc-item"><a href="#fractal-tree-implementation">Fractal tree implementation</a></div><div class="toc-item"><a href="#space-blast">Space blast</a></div><div class="toc-item"><a href="#gui-demo">GUI Demo</a></div><div class="toc-item"><a href="#wasm4-demo-notes">WASM4 Demo - notes</a></div><div class="toc-item"><a href="#wasm4-demo-snake">WASM4 Demo - snake</a></div></div></div><div class="boxes"><hr><div class="box"><div class="content"><div class="banner-image"><img alt="Yaksha Programming Language"src="images/yk-banner.png"style="max-width:100%"></div></div><div class="note"></div></div><div class="box"><div class="content"><h2 id="fractal-tree-implementation">Fractal tree implementation</h2><span class="timestamp">Created 2023-08-13, Last Updated 2023-08-13</span></div><div class="note"></div></div><div class="box"><div class="content"><p>Hint: Refresh to get a new random tree</div><div class="note"></div></div><div class="box"><div class="content"><details open><summary>Code</summary><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">raylib</span> <span class="k">as</span> <span class="nn">rl</span>
<span class="kn">import</span> <span class="nn">raylib.utils</span>
<span class="kn">import</span> <span class="nn">libs.numbers</span> <span class="k">as</span> <span class="nn">num</span>
<span class="kn">import</span> <span class="nn">libs.perlin</span>
<span class="kn">import</span> <span class="nn">libs.random</span>


<span class="k">class</span> <span class="nc">State</span><span class="p">:</span>
    <span class="n">width</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">height</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">angle</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">frame_count</span><span class="p">:</span> <span class="nb">u64</span>
    <span class="n">blue</span><span class="p">:</span> <span class="n">rl</span><span class="o">.</span><span class="n">Color</span>
    <span class="n">green</span><span class="p">:</span> <span class="n">rl</span><span class="o">.</span><span class="n">Color</span>
    <span class="n">color3</span><span class="p">:</span> <span class="n">rl</span><span class="o">.</span><span class="n">Color</span>


<span class="k">def</span> <span class="nf">branch</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">length</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">angle</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="n">State</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">length</span> <span class="o">&lt;</span> <span class="mf">4.0f</span><span class="p">:</span>
        <span class="n">leaf_width</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">random_betweenf</span><span class="p">(</span><span class="mf">1.0f</span><span class="p">,</span> <span class="mf">3.0f</span><span class="p">)</span>
        <span class="n">leaf_height</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">random_betweenf</span><span class="p">(</span><span class="mf">3.0f</span><span class="p">,</span> <span class="mf">6.0f</span><span class="p">)</span>
        <span class="n">lerped_green</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">lerp_color</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">green</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">blue</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">remap</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">0.0f</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="mf">0.0f</span><span class="p">,</span> <span class="mf">1.0f</span><span class="p">)</span> <span class="o">*</span> <span class="mf">2.0f</span><span class="p">)</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">lerp_color</span><span class="p">(</span><span class="n">lerped_green</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">color3</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">remap</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mf">0.0f</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="mf">0.0f</span><span class="p">,</span> <span class="mf">1.0f</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.5f</span><span class="p">)</span>
        <span class="n">rl</span><span class="o">.</span><span class="n">draw_ellipse</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">f2i</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">num</span><span class="o">.</span><span class="n">f2i</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">leaf_height</span><span class="p">,</span> <span class="n">leaf_width</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">wind</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">sin_deg</span><span class="p">(</span><span class="n">perlin</span><span class="o">.</span><span class="n">noise1df</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">uu2f</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">frame_count</span><span class="p">)</span> <span class="o">/</span> <span class="mf">50.0f</span><span class="p">))</span> <span class="o">*</span> <span class="mf">100.0f</span> <span class="o">*</span> <span class="n">utils</span><span class="o">.</span><span class="n">sin_deg</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">uu2f</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">frame_count</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0f</span><span class="p">)</span>
    <span class="n">next_y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">length</span> <span class="o">*</span> <span class="n">utils</span><span class="o">.</span><span class="n">cos_deg</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
    <span class="n">next_x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">length</span> <span class="o">*</span> <span class="n">utils</span><span class="o">.</span><span class="n">sin_deg</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
    <span class="n">thick</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">remap</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="mf">0.0f</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">height</span> <span class="o">/</span> <span class="mf">4.0f</span><span class="p">,</span> <span class="mf">2.0f</span><span class="p">,</span> <span class="mf">6.0f</span><span class="p">)</span>
    <span class="n">rl</span><span class="o">.</span><span class="n">draw_line_ex</span><span class="p">(</span><span class="n">rl</span><span class="o">.</span><span class="n">vector2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">rl</span><span class="o">.</span><span class="n">vector2</span><span class="p">(</span><span class="n">next_x</span><span class="p">,</span> <span class="n">next_y</span><span class="p">),</span> <span class="n">thick</span><span class="p">,</span> <span class="n">rl</span><span class="o">.</span><span class="n">color</span><span class="p">(</span><span class="mi">152</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span>
    <span class="n">r1</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">random_betweenf</span><span class="p">(</span><span class="mf">0.3f</span><span class="p">,</span> <span class="mf">0.9f</span><span class="p">)</span>
    <span class="n">r2</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">random_betweenf</span><span class="p">(</span><span class="mf">0.5f</span><span class="p">,</span> <span class="mf">0.8f</span><span class="p">)</span>
    <span class="n">branch</span><span class="p">(</span><span class="n">next_x</span><span class="p">,</span> <span class="n">next_y</span><span class="p">,</span> <span class="p">(</span><span class="n">length</span> <span class="o">*</span> <span class="n">r2</span><span class="p">),</span> <span class="n">angle</span> <span class="o">+</span> <span class="n">s</span><span class="o">.</span><span class="n">angle</span> <span class="o">+</span> <span class="n">wind</span> <span class="o">*</span> <span class="mf">10.0f</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
    <span class="n">branch</span><span class="p">(</span><span class="n">next_x</span><span class="p">,</span> <span class="n">next_y</span><span class="p">,</span> <span class="p">(</span><span class="n">length</span> <span class="o">*</span> <span class="n">r1</span><span class="p">),</span> <span class="n">angle</span> <span class="o">-</span> <span class="n">s</span><span class="o">.</span><span class="n">angle</span> <span class="o">+</span> <span class="n">wind</span> <span class="o">*</span> <span class="mf">10.0f</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">update_draw_frame</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="n">State</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">rl</span><span class="o">.</span><span class="n">clear_background</span><span class="p">(</span><span class="n">rl</span><span class="o">.</span><span class="n">color</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span>
    <span class="n">branch</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="mf">2.0f</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">height</span> <span class="o">/</span> <span class="mf">4.0f</span><span class="p">,</span> <span class="mf">0.0f</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">s</span><span class="p">:</span> <span class="n">State</span> <span class="o">=</span> <span class="n">State</span><span class="p">()</span>
    <span class="n">s</span><span class="o">.</span><span class="n">angle</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">random_betweenf</span><span class="p">(</span><span class="mf">30.0f</span><span class="p">,</span> <span class="mf">45.0f</span><span class="p">)</span>
    <span class="n">s</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="mf">600.0f</span>
    <span class="n">s</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="mf">600.0f</span>
    <span class="n">s</span><span class="o">.</span><span class="n">frame_count</span> <span class="o">=</span> <span class="mi">0u64</span>
    <span class="n">s</span><span class="o">.</span><span class="n">blue</span> <span class="o">=</span> <span class="n">rl</span><span class="o">.</span><span class="n">color</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">214</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
    <span class="n">s</span><span class="o">.</span><span class="n">green</span> <span class="o">=</span> <span class="n">rl</span><span class="o">.</span><span class="n">color</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
    <span class="n">s</span><span class="o">.</span><span class="n">color3</span> <span class="o">=</span> <span class="n">rl</span><span class="o">.</span><span class="n">color</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">156</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
    <span class="n">rl</span><span class="o">.</span><span class="n">init_window</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">f2i</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">width</span><span class="p">),</span> <span class="n">num</span><span class="o">.</span><span class="n">f2i</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">height</span><span class="p">),</span> <span class="s2">&quot;Fractal Tree in the Wind&quot;</span><span class="p">)</span>
    <span class="n">rl</span><span class="o">.</span><span class="n">set_target_fps</span><span class="p">(</span><span class="mi">120</span><span class="p">)</span>
    <span class="n">seed</span><span class="p">:</span> <span class="nb">u64</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">init_random</span><span class="p">()</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">rl</span><span class="o">.</span><span class="n">window_should_close</span><span class="p">():</span>
        <span class="n">rl</span><span class="o">.</span><span class="n">begin_drawing</span><span class="p">()</span>
        <span class="n">update_draw_frame</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">rl</span><span class="o">.</span><span class="n">draw_fps</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">rl</span><span class="o">.</span><span class="n">end_drawing</span><span class="p">()</span>
        <span class="n">s</span><span class="o">.</span><span class="n">frame_count</span> <span class="o">+=</span> <span class="mi">1u64</span>
        <span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">rl</span><span class="o">.</span><span class="n">close_window</span><span class="p">()</span>
    <span class="k">del</span> <span class="n">s</span>
    <span class="k">return</span> <span class="mi">0</span>
</pre></div></details></div><div class="note"></div></div><div class="box"><div class="content"><a href="/static_demos/tree/wind_tree.html"target="_blank">Show demo in a new tab</a><details open><summary>Show demo inline</summary><iframe src="/static_demos/tree/wind_tree.html"width="100%"height="700px"style="border:none">&nbsp</iframe></details></div><div class="note"></div></div><div class="box"><div class="content"><hr></div><div class="note"><hr></div></div><div class="box"><div class="content"><h2 id="space-blast">Space blast</h2><span class="timestamp">Created 2023-08-13, Last Updated 2023-08-13</span></div><div class="note"></div></div><div class="box"><div class="content"><p>Hint: You need a keyboard to play this</div><div class="note"></div></div><div class="box"><div class="content"><details open><summary>Code</summary><div class="highlight"><pre><span></span><span class="c1"># All assets from https://www.kenney.nl/assets/</span>
<span class="c1"># Code ported to Yaksha based on https://github.com/tashvit/space-blast</span>

<span class="kn">import</span> <span class="nn">raylib</span> <span class="k">as</span> <span class="nn">rl</span>
<span class="kn">import</span> <span class="nn">raylib.utils</span>
<span class="kn">import</span> <span class="nn">libs.numbers</span> <span class="k">as</span> <span class="nn">num</span>
<span class="kn">import</span> <span class="nn">libs.perlin</span>
<span class="kn">import</span> <span class="nn">libs.random</span>

<span class="n">SCENE_TITLE</span><span class="p">:</span> <span class="nb">Const</span><span class="p">[</span><span class="nb">u8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0u8</span>
<span class="n">SCENE_PLAY</span><span class="p">:</span> <span class="nb">Const</span><span class="p">[</span><span class="nb">u8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1u8</span>
<span class="n">SCENE_GAME_OVER</span><span class="p">:</span> <span class="nb">Const</span><span class="p">[</span><span class="nb">u8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2u8</span>
<span class="n">GAME_W</span><span class="p">:</span> <span class="nb">Const</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1920</span>
<span class="n">GAME_H</span><span class="p">:</span> <span class="nb">Const</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1080</span>
<span class="n">STAR_COUNT</span><span class="p">:</span> <span class="nb">Const</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">ENEMY_COUNT</span><span class="p">:</span> <span class="nb">Const</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">FPS_TARGET</span><span class="p">:</span> <span class="nb">Const</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">60</span>
<span class="n">PLAYER_BULLETS</span><span class="p">:</span> <span class="nb">Const</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">ENEMY_BULLET_MAX</span><span class="p">:</span> <span class="nb">Const</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>

<span class="nd">@onstack</span>
<span class="k">class</span> <span class="nc">Star</span><span class="p">:</span>
    <span class="n">x</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">y</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">speed</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">r</span><span class="p">:</span> <span class="nb">int</span>

<span class="nd">@onstack</span>
<span class="k">class</span> <span class="nc">Bullet</span><span class="p">:</span>
    <span class="n">x</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">y</span><span class="p">:</span> <span class="nb">int</span>

<span class="nd">@onstack</span>
<span class="k">class</span> <span class="nc">Enemy</span><span class="p">:</span>
    <span class="n">x</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">y</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">speed</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">type</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">swing</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">bullet</span><span class="p">:</span> <span class="n">Bullet</span>

<span class="k">class</span> <span class="nc">State</span><span class="p">:</span>
    <span class="n">frame_count</span><span class="p">:</span> <span class="nb">u64</span>
    <span class="n">assets</span><span class="p">:</span> <span class="n">Assets</span>
    <span class="n">player_x</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">player_y</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">speed</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">stars</span><span class="p">:</span> <span class="nb">Array</span><span class="p">[</span><span class="n">Star</span><span class="p">]</span>
    <span class="n">enemies</span><span class="p">:</span> <span class="nb">Array</span><span class="p">[</span><span class="n">Enemy</span><span class="p">]</span>
    <span class="n">scene</span><span class="p">:</span> <span class="nb">u8</span>
    <span class="n">player_moving</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">player_bullets</span><span class="p">:</span> <span class="nb">Array</span><span class="p">[</span><span class="n">Bullet</span><span class="p">]</span>
    <span class="n">player_score</span><span class="p">:</span> <span class="nb">int</span>

<span class="k">class</span> <span class="nc">Assets</span><span class="p">:</span>
    <span class="n">loaded</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">bg</span><span class="p">:</span> <span class="n">rl</span><span class="o">.</span><span class="n">Color</span>
    <span class="n">white</span><span class="p">:</span> <span class="n">rl</span><span class="o">.</span><span class="n">Color</span>
    <span class="n">player</span><span class="p">:</span> <span class="n">rl</span><span class="o">.</span><span class="n">Texture2D</span>
    <span class="n">enemy1</span><span class="p">:</span> <span class="n">rl</span><span class="o">.</span><span class="n">Texture2D</span>
    <span class="n">enemy2</span><span class="p">:</span> <span class="n">rl</span><span class="o">.</span><span class="n">Texture2D</span>
    <span class="n">enemy3</span><span class="p">:</span> <span class="n">rl</span><span class="o">.</span><span class="n">Texture2D</span>
    <span class="n">enemy4</span><span class="p">:</span> <span class="n">rl</span><span class="o">.</span><span class="n">Texture2D</span>
    <span class="n">enemy5</span><span class="p">:</span> <span class="n">rl</span><span class="o">.</span><span class="n">Texture2D</span>
    <span class="n">meteor</span><span class="p">:</span> <span class="n">rl</span><span class="o">.</span><span class="n">Texture2D</span>
    <span class="n">enemy_laser</span><span class="p">:</span> <span class="n">rl</span><span class="o">.</span><span class="n">Texture2D</span>
    <span class="n">player_laser</span><span class="p">:</span> <span class="n">rl</span><span class="o">.</span><span class="n">Texture2D</span>
    <span class="n">enemy_laser_sound</span><span class="p">:</span> <span class="n">rl</span><span class="o">.</span><span class="n">Sound</span>
    <span class="n">player_laser_sound</span><span class="p">:</span> <span class="n">rl</span><span class="o">.</span><span class="n">Sound</span>
    <span class="n">explosion_sound</span><span class="p">:</span> <span class="n">rl</span><span class="o">.</span><span class="n">Sound</span>

<span class="k">def</span> <span class="nf">update_stars</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="n">State</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">star</span><span class="p">:</span> <span class="n">Star</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">stars</span><span class="p">:</span>
        <span class="n">star</span><span class="o">.</span><span class="n">y</span> <span class="o">+=</span> <span class="n">star</span><span class="o">.</span><span class="n">speed</span>
        <span class="c1"># if we are out of the screen recreate the star</span>
        <span class="k">if</span> <span class="n">star</span><span class="o">.</span><span class="n">y</span> <span class="o">&gt;</span> <span class="n">GAME_H</span> <span class="o">+</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">star</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span>
            <span class="n">star</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">rl</span><span class="o">.</span><span class="n">get_random_value</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GAME_W</span><span class="p">)</span>
            <span class="n">star</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">rl</span><span class="o">.</span><span class="n">get_random_value</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">update_player_bullets</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="n">State</span><span class="p">,</span> <span class="n">pressed_fire</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">to_fire</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">pressed_fire</span>
    <span class="k">for</span> <span class="n">bullet</span><span class="p">:</span> <span class="n">Bullet</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">player_bullets</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">bullet</span><span class="o">.</span><span class="n">y</span> <span class="o">==</span> <span class="o">-</span><span class="mi">999</span> <span class="ow">and</span> <span class="n">to_fire</span> <span class="ow">and</span> <span class="n">s</span><span class="o">.</span><span class="n">frame_count</span> <span class="o">%</span> <span class="mi">8u64</span> <span class="o">==</span> <span class="mi">0u64</span><span class="p">:</span>
            <span class="n">bullet</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">player_y</span> <span class="o">-</span> <span class="mi">32</span>
            <span class="n">bullet</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">player_x</span> <span class="o">-</span> <span class="mi">32</span>
            <span class="n">rl</span><span class="o">.</span><span class="n">play_sound</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">player_laser_sound</span><span class="p">)</span>
            <span class="n">to_fire</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">bullet</span><span class="o">.</span><span class="n">y</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">bullet</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="o">-</span><span class="mi">999</span>
            <span class="n">bullet</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="o">-</span><span class="mi">999</span>
        <span class="k">if</span> <span class="n">bullet</span><span class="o">.</span><span class="n">y</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">999</span><span class="p">:</span>
            <span class="n">bullet</span><span class="o">.</span><span class="n">y</span> <span class="o">-=</span> <span class="mi">10</span>

<span class="k">def</span> <span class="nf">update_player</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="n">State</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">w2</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;int&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">player</span><span class="o">.</span><span class="n">width</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">h2</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;int&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">player</span><span class="o">.</span><span class="n">height</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">s</span><span class="o">.</span><span class="n">player_moving</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># User pressed a key -&gt; move the player</span>
    <span class="k">if</span> <span class="n">rl</span><span class="o">.</span><span class="n">is_key_down</span><span class="p">(</span><span class="n">rl</span><span class="o">.</span><span class="n">KEY_W</span><span class="p">)</span> <span class="ow">or</span> <span class="n">rl</span><span class="o">.</span><span class="n">is_key_down</span><span class="p">(</span><span class="n">rl</span><span class="o">.</span><span class="n">KEY_UP</span><span class="p">):</span>
        <span class="n">s</span><span class="o">.</span><span class="n">player_y</span> <span class="o">-=</span> <span class="n">s</span><span class="o">.</span><span class="n">speed</span>
        <span class="n">s</span><span class="o">.</span><span class="n">player_moving</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">rl</span><span class="o">.</span><span class="n">is_key_down</span><span class="p">(</span><span class="n">rl</span><span class="o">.</span><span class="n">KEY_A</span><span class="p">)</span> <span class="ow">or</span> <span class="n">rl</span><span class="o">.</span><span class="n">is_key_down</span><span class="p">(</span><span class="n">rl</span><span class="o">.</span><span class="n">KEY_LEFT</span><span class="p">):</span>
        <span class="n">s</span><span class="o">.</span><span class="n">player_x</span> <span class="o">-=</span> <span class="n">s</span><span class="o">.</span><span class="n">speed</span>
        <span class="n">s</span><span class="o">.</span><span class="n">player_moving</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">rl</span><span class="o">.</span><span class="n">is_key_down</span><span class="p">(</span><span class="n">rl</span><span class="o">.</span><span class="n">KEY_S</span><span class="p">)</span> <span class="ow">or</span> <span class="n">rl</span><span class="o">.</span><span class="n">is_key_down</span><span class="p">(</span><span class="n">rl</span><span class="o">.</span><span class="n">KEY_DOWN</span><span class="p">):</span>
        <span class="n">s</span><span class="o">.</span><span class="n">player_y</span> <span class="o">+=</span> <span class="n">s</span><span class="o">.</span><span class="n">speed</span>
        <span class="n">s</span><span class="o">.</span><span class="n">player_moving</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">rl</span><span class="o">.</span><span class="n">is_key_down</span><span class="p">(</span><span class="n">rl</span><span class="o">.</span><span class="n">KEY_D</span><span class="p">)</span> <span class="ow">or</span> <span class="n">rl</span><span class="o">.</span><span class="n">is_key_down</span><span class="p">(</span><span class="n">rl</span><span class="o">.</span><span class="n">KEY_RIGHT</span><span class="p">):</span>
        <span class="n">s</span><span class="o">.</span><span class="n">player_x</span> <span class="o">+=</span> <span class="n">s</span><span class="o">.</span><span class="n">speed</span>
        <span class="n">s</span><span class="o">.</span><span class="n">player_moving</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">update_player_bullets</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">rl</span><span class="o">.</span><span class="n">is_key_down</span><span class="p">(</span><span class="n">rl</span><span class="o">.</span><span class="n">KEY_SPACE</span><span class="p">))</span>

    <span class="c1"># Ensure that the player width/height is constrained</span>
    <span class="c1"># So we cannot go out of the bounds</span>
    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">player_x</span> <span class="o">&lt;=</span> <span class="n">w2</span><span class="p">:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">player_x</span> <span class="o">=</span> <span class="n">w2</span>
    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">player_x</span> <span class="o">&gt;=</span> <span class="n">GAME_W</span> <span class="o">-</span> <span class="n">w2</span><span class="p">:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">player_x</span> <span class="o">=</span> <span class="n">GAME_W</span> <span class="o">-</span> <span class="n">w2</span>
    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">player_y</span> <span class="o">&lt;=</span> <span class="n">h2</span><span class="p">:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">player_y</span> <span class="o">=</span> <span class="n">h2</span>
    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">player_y</span> <span class="o">&gt;=</span> <span class="n">GAME_H</span> <span class="o">-</span> <span class="n">h2</span><span class="p">:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">player_y</span> <span class="o">=</span> <span class="n">GAME_H</span> <span class="o">-</span> <span class="n">h2</span>
    <span class="c1"># Check collisions with enemies</span>
    <span class="k">for</span> <span class="n">enemy</span><span class="p">:</span> <span class="n">Enemy</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">enemies</span><span class="p">:</span>
        <span class="n">enemy_collide</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">collides</span><span class="p">(</span><span class="n">get_enemy_ship</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">enemy</span><span class="o">.</span><span class="n">type</span><span class="p">),</span> <span class="n">enemy</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">enemy</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">player</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">player_x</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">player_y</span><span class="p">)</span>
        <span class="n">bullet_collide</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">collides</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">enemy_laser</span><span class="p">,</span> <span class="n">enemy</span><span class="o">.</span><span class="n">bullet</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">enemy</span><span class="o">.</span><span class="n">bullet</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">player</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">player_x</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">player_y</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">enemy_collide</span> <span class="ow">or</span> <span class="n">bullet_collide</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">scene</span> <span class="o">=</span> <span class="n">SCENE_GAME_OVER</span>
            <span class="n">rl</span><span class="o">.</span><span class="n">play_sound</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">explosion_sound</span><span class="p">)</span>
            <span class="k">break</span>
        <span class="k">for</span> <span class="n">bullet</span><span class="p">:</span> <span class="n">Bullet</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">player_bullets</span><span class="p">:</span>
            <span class="n">enemy_in_fire</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">collides</span><span class="p">(</span><span class="n">get_enemy_ship</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">enemy</span><span class="o">.</span><span class="n">type</span><span class="p">),</span> <span class="n">enemy</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">enemy</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">player_laser</span><span class="p">,</span> <span class="n">bullet</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">bullet</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
            <span class="n">bulllets_collide</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">collides</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">enemy_laser</span><span class="p">,</span> <span class="n">enemy</span><span class="o">.</span><span class="n">bullet</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">enemy</span><span class="o">.</span><span class="n">bullet</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">player_laser</span><span class="p">,</span> <span class="n">bullet</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">bullet</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">bullet</span><span class="o">.</span><span class="n">y</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">999</span> <span class="ow">and</span> <span class="n">enemy_in_fire</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">player_score</span> <span class="o">+=</span> <span class="mi">10</span>
                <span class="n">enemy</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">GAME_H</span> <span class="o">+</span> <span class="mi">50</span>
                <span class="n">bullet</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="o">-</span><span class="mi">999</span>
                <span class="n">bullet</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="o">-</span><span class="mi">999</span>
                <span class="n">rl</span><span class="o">.</span><span class="n">play_sound</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">explosion_sound</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">bullet</span><span class="o">.</span><span class="n">y</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">999</span> <span class="ow">and</span> <span class="n">bulllets_collide</span><span class="p">:</span>
                <span class="n">enemy</span><span class="o">.</span><span class="n">bullet</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="o">-</span><span class="mi">999</span>
                <span class="n">enemy</span><span class="o">.</span><span class="n">bullet</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="o">-</span><span class="mi">999</span>
                <span class="n">bullet</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="o">-</span><span class="mi">999</span>
                <span class="n">bullet</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="o">-</span><span class="mi">999</span>

<span class="k">def</span> <span class="nf">update_enemies</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="n">State</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">active_bullets</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">enemy</span><span class="p">:</span> <span class="n">Enemy</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">enemies</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">enemy</span><span class="o">.</span><span class="n">bullet</span><span class="o">.</span><span class="n">y</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">999</span><span class="p">:</span>
            <span class="n">active_bullets</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">for</span> <span class="n">enemy</span><span class="p">:</span> <span class="n">Enemy</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">enemies</span><span class="p">:</span>
        <span class="n">enemy</span><span class="o">.</span><span class="n">y</span> <span class="o">+=</span> <span class="n">enemy</span><span class="o">.</span><span class="n">speed</span>
        <span class="n">swing</span><span class="p">:</span> <span class="nb">u64</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;u64&quot;</span><span class="p">,</span> <span class="n">enemy</span><span class="o">.</span><span class="n">swing</span><span class="p">)</span> <span class="o">+</span> <span class="n">s</span><span class="o">.</span><span class="n">frame_count</span>
        <span class="n">enemy</span><span class="o">.</span><span class="n">x</span> <span class="o">+=</span> <span class="n">enemy</span><span class="o">.</span><span class="n">speed</span> <span class="o">*</span> <span class="n">iif</span><span class="p">(</span><span class="n">swing</span> <span class="o">%</span> <span class="mi">60u64</span> <span class="o">&lt;</span> <span class="mi">30u64</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">enemy</span><span class="o">.</span><span class="n">y</span> <span class="o">&gt;</span> <span class="n">GAME_H</span> <span class="o">+</span> <span class="mi">50</span><span class="p">:</span>
            <span class="n">enemy</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="o">-</span><span class="n">rl</span><span class="o">.</span><span class="n">get_random_value</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
            <span class="n">enemy</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">rl</span><span class="o">.</span><span class="n">get_random_value</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GAME_W</span><span class="p">)</span>
            <span class="n">enemy</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">rl</span><span class="o">.</span><span class="n">get_random_value</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
            <span class="n">enemy</span><span class="o">.</span><span class="n">swing</span> <span class="o">=</span> <span class="n">rl</span><span class="o">.</span><span class="n">get_random_value</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">swing</span> <span class="o">%</span> <span class="mi">6u64</span> <span class="o">==</span> <span class="mi">0u64</span> <span class="ow">and</span> <span class="n">enemy</span><span class="o">.</span><span class="n">bullet</span><span class="o">.</span><span class="n">y</span> <span class="o">==</span> <span class="o">-</span><span class="mi">999</span> <span class="ow">and</span> <span class="n">enemy</span><span class="o">.</span><span class="n">y</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="ow">and</span> <span class="n">active_bullets</span> <span class="o">&lt;</span> <span class="n">ENEMY_BULLET_MAX</span><span class="p">:</span>
            <span class="n">enemy</span><span class="o">.</span><span class="n">bullet</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">enemy</span><span class="o">.</span><span class="n">x</span> <span class="o">+</span> <span class="mi">32</span>
            <span class="n">enemy</span><span class="o">.</span><span class="n">bullet</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">enemy</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="mi">32</span>
            <span class="n">rl</span><span class="o">.</span><span class="n">play_sound</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">enemy_laser_sound</span><span class="p">)</span>
            <span class="n">active_bullets</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">enemy</span><span class="o">.</span><span class="n">bullet</span><span class="o">.</span><span class="n">y</span> <span class="o">&gt;</span> <span class="n">GAME_H</span> <span class="o">+</span> <span class="mi">50</span><span class="p">:</span>
            <span class="n">enemy</span><span class="o">.</span><span class="n">bullet</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="o">-</span><span class="mi">999</span>
            <span class="n">enemy</span><span class="o">.</span><span class="n">bullet</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="o">-</span><span class="mi">999</span>
            <span class="n">active_bullets</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">enemy</span><span class="o">.</span><span class="n">bullet</span><span class="o">.</span><span class="n">y</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">999</span><span class="p">:</span>
            <span class="n">enemy</span><span class="o">.</span><span class="n">bullet</span><span class="o">.</span><span class="n">y</span> <span class="o">+=</span> <span class="mi">6</span>

<span class="k">def</span> <span class="nf">draw_stars</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="n">State</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">star</span><span class="p">:</span> <span class="n">Star</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">stars</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">star</span><span class="o">.</span><span class="n">r</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">draw_image</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">meteor</span><span class="p">,</span> <span class="n">star</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">star</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rl</span><span class="o">.</span><span class="n">draw_circle</span><span class="p">(</span><span class="n">star</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">star</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;float&quot;</span><span class="p">,</span> <span class="n">star</span><span class="o">.</span><span class="n">r</span><span class="p">),</span> <span class="n">s</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">white</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">draw_enemies</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="n">State</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">enemy</span><span class="p">:</span> <span class="n">Enemy</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">enemies</span><span class="p">:</span>
        <span class="n">draw_image</span><span class="p">(</span><span class="n">get_enemy_ship</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">enemy</span><span class="o">.</span><span class="n">type</span><span class="p">),</span> <span class="n">enemy</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">enemy</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">enemy</span><span class="o">.</span><span class="n">bullet</span><span class="o">.</span><span class="n">y</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">999</span><span class="p">:</span>
            <span class="n">draw_image</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">enemy_laser</span><span class="p">,</span> <span class="n">enemy</span><span class="o">.</span><span class="n">bullet</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">enemy</span><span class="o">.</span><span class="n">bullet</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">draw_player</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="n">State</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">draw_image</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">player</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">player_x</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">player_y</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">bullet</span><span class="p">:</span> <span class="n">Bullet</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">player_bullets</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">bullet</span><span class="o">.</span><span class="n">y</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">999</span><span class="p">:</span>
            <span class="n">draw_image</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">player_laser</span><span class="p">,</span> <span class="n">bullet</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">bullet</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">game_step</span><span class="p">(</span><span class="n">d</span><span class="p">:</span> <span class="n">utils</span><span class="o">.</span><span class="n">Data</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">s</span><span class="p">:</span> <span class="n">State</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;State&quot;</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
    <span class="n">ensure_assets</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="n">rl</span><span class="o">.</span><span class="n">begin_drawing</span><span class="p">()</span>
    <span class="n">rl</span><span class="o">.</span><span class="n">clear_background</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">bg</span><span class="p">)</span>
    <span class="c1"># ----------------------------------------------</span>
    <span class="c1"># ----------------------------------------------</span>
    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">scene</span> <span class="o">==</span> <span class="n">SCENE_PLAY</span><span class="p">:</span>
        <span class="n">update_player</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">update_stars</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">update_enemies</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">frame_count</span> <span class="o">%</span> <span class="mi">60u64</span> <span class="o">==</span> <span class="mi">0u64</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">player_score</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">draw_stars</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="n">draw_player</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="n">draw_enemies</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">scene</span> <span class="o">==</span> <span class="n">SCENE_TITLE</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">frame_count</span> <span class="o">/</span> <span class="mi">50u64</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2u64</span> <span class="o">==</span> <span class="mi">0u64</span><span class="p">:</span>
            <span class="n">rl</span><span class="o">.</span><span class="n">draw_text</span><span class="p">(</span><span class="s2">&quot;Press [enter] to start&quot;</span><span class="p">,</span> <span class="n">GAME_W</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">450</span><span class="p">,</span> <span class="n">GAME_H</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">white</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rl</span><span class="o">.</span><span class="n">is_key_down</span><span class="p">(</span><span class="n">rl</span><span class="o">.</span><span class="n">KEY_ENTER</span><span class="p">):</span>
            <span class="n">s</span><span class="o">.</span><span class="n">scene</span> <span class="o">=</span> <span class="n">SCENE_PLAY</span>
    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">scene</span> <span class="o">==</span> <span class="n">SCENE_GAME_OVER</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">frame_count</span> <span class="o">/</span> <span class="mi">50u64</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2u64</span> <span class="o">==</span> <span class="mi">0u64</span><span class="p">:</span>
            <span class="n">rl</span><span class="o">.</span><span class="n">draw_text</span><span class="p">(</span><span class="s2">&quot;Game over &quot;</span><span class="p">,</span> <span class="n">GAME_W</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">200</span><span class="p">,</span> <span class="n">GAME_H</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">white</span><span class="p">)</span>
            <span class="n">rl</span><span class="o">.</span><span class="n">draw_text</span><span class="p">(</span><span class="s2">&quot;Press [enter] to start&quot;</span><span class="p">,</span> <span class="n">GAME_W</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">450</span><span class="p">,</span> <span class="n">GAME_H</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">white</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rl</span><span class="o">.</span><span class="n">is_key_down</span><span class="p">(</span><span class="n">rl</span><span class="o">.</span><span class="n">KEY_ENTER</span><span class="p">):</span>
            <span class="n">s</span><span class="o">.</span><span class="n">scene</span> <span class="o">=</span> <span class="n">SCENE_PLAY</span>
            <span class="n">reset_state</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="c1"># -----------------------------------------------</span>
    <span class="c1"># ----------------------------------------------</span>
    <span class="n">rl</span><span class="o">.</span><span class="n">draw_fps</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">rl</span><span class="o">.</span><span class="n">draw_text</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">i2s</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">player_score</span><span class="p">),</span> <span class="n">GAME_W</span> <span class="o">-</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">rl</span><span class="o">.</span><span class="n">color</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span>
    <span class="n">rl</span><span class="o">.</span><span class="n">end_drawing</span><span class="p">()</span>
    <span class="n">s</span><span class="o">.</span><span class="n">frame_count</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">frame_count</span> <span class="o">+</span> <span class="mi">1u64</span>

<span class="k">def</span> <span class="nf">init_state</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">State</span><span class="p">:</span>
    <span class="n">s</span><span class="p">:</span> <span class="n">State</span> <span class="o">=</span> <span class="n">State</span><span class="p">()</span>
    <span class="n">s</span><span class="o">.</span><span class="n">frame_count</span> <span class="o">=</span> <span class="mi">0u64</span>
    <span class="n">s</span><span class="o">.</span><span class="n">assets</span> <span class="o">=</span> <span class="n">Assets</span><span class="p">()</span>
    <span class="n">s</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">loaded</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">s</span><span class="o">.</span><span class="n">stars</span> <span class="o">=</span> <span class="n">arrnew</span><span class="p">(</span><span class="s2">&quot;Star&quot;</span><span class="p">,</span> <span class="n">STAR_COUNT</span><span class="p">)</span>
    <span class="n">s</span><span class="o">.</span><span class="n">enemies</span> <span class="o">=</span> <span class="n">arrnew</span><span class="p">(</span><span class="s2">&quot;Enemy&quot;</span><span class="p">,</span> <span class="n">ENEMY_COUNT</span><span class="p">)</span>
    <span class="n">s</span><span class="o">.</span><span class="n">player_bullets</span> <span class="o">=</span> <span class="n">arrnew</span><span class="p">(</span><span class="s2">&quot;Bullet&quot;</span><span class="p">,</span> <span class="n">PLAYER_BULLETS</span><span class="p">)</span>
    <span class="n">random</span><span class="o">.</span><span class="n">init_random</span><span class="p">()</span>
    <span class="n">reset_state</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span>

<span class="k">def</span> <span class="nf">reset_state</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="n">State</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">s</span><span class="o">.</span><span class="n">player_x</span> <span class="o">=</span> <span class="n">GAME_H</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">s</span><span class="o">.</span><span class="n">player_y</span> <span class="o">=</span> <span class="n">GAME_W</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">s</span><span class="o">.</span><span class="n">speed</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">s</span><span class="o">.</span><span class="n">player_score</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">bullet</span><span class="p">:</span> <span class="n">Bullet</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">player_bullets</span><span class="p">:</span>
        <span class="n">bullet</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="o">-</span><span class="mi">999</span>
        <span class="n">bullet</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="o">-</span><span class="mi">999</span>

    <span class="k">for</span> <span class="n">star</span><span class="p">:</span> <span class="n">Star</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">stars</span><span class="p">:</span>
        <span class="n">star</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">rl</span><span class="o">.</span><span class="n">get_random_value</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GAME_W</span><span class="p">)</span>
        <span class="n">star</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">rl</span><span class="o">.</span><span class="n">get_random_value</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GAME_H</span><span class="p">)</span>
        <span class="n">star</span><span class="o">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">rl</span><span class="o">.</span><span class="n">get_random_value</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">star</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">rl</span><span class="o">.</span><span class="n">get_random_value</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">enemy</span><span class="p">:</span> <span class="n">Enemy</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">enemies</span><span class="p">:</span>
        <span class="n">enemy</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">rl</span><span class="o">.</span><span class="n">get_random_value</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GAME_W</span><span class="p">)</span>
        <span class="n">enemy</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="o">-</span><span class="n">rl</span><span class="o">.</span><span class="n">get_random_value</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">enemy</span><span class="o">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">rl</span><span class="o">.</span><span class="n">get_random_value</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="n">enemy</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">rl</span><span class="o">.</span><span class="n">get_random_value</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="n">enemy</span><span class="o">.</span><span class="n">swing</span> <span class="o">=</span> <span class="n">rl</span><span class="o">.</span><span class="n">get_random_value</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span>
        <span class="n">enemy</span><span class="o">.</span><span class="n">bullet</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="o">-</span><span class="mi">999</span>
        <span class="n">enemy</span><span class="o">.</span><span class="n">bullet</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="o">-</span><span class="mi">999</span>

<span class="k">def</span> <span class="nf">ensure_assets</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="n">State</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">loaded</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">s</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">bg</span> <span class="o">=</span> <span class="n">rl</span><span class="o">.</span><span class="n">color</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
    <span class="n">s</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">white</span> <span class="o">=</span> <span class="n">rl</span><span class="o">.</span><span class="n">color</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
    <span class="n">s</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">player</span> <span class="o">=</span> <span class="n">load_image</span><span class="p">(</span><span class="s2">&quot;playerShip1_blue.png&quot;</span><span class="p">)</span>
    <span class="n">s</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">enemy1</span> <span class="o">=</span> <span class="n">load_image</span><span class="p">(</span><span class="s2">&quot;shipBeige_manned.png&quot;</span><span class="p">)</span>
    <span class="n">s</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">enemy2</span> <span class="o">=</span> <span class="n">load_image</span><span class="p">(</span><span class="s2">&quot;shipBlue_manned.png&quot;</span><span class="p">)</span>
    <span class="n">s</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">enemy3</span> <span class="o">=</span> <span class="n">load_image</span><span class="p">(</span><span class="s2">&quot;shipPink_manned.png&quot;</span><span class="p">)</span>
    <span class="n">s</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">enemy4</span> <span class="o">=</span> <span class="n">load_image</span><span class="p">(</span><span class="s2">&quot;shipGreen_manned.png&quot;</span><span class="p">)</span>
    <span class="n">s</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">enemy5</span> <span class="o">=</span> <span class="n">load_image</span><span class="p">(</span><span class="s2">&quot;shipYellow_manned.png&quot;</span><span class="p">)</span>
    <span class="n">s</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">meteor</span> <span class="o">=</span> <span class="n">load_image</span><span class="p">(</span><span class="s2">&quot;meteorGrey_tiny2.png&quot;</span><span class="p">)</span>
    <span class="n">s</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">enemy_laser</span> <span class="o">=</span> <span class="n">load_image</span><span class="p">(</span><span class="s2">&quot;laserRed03.png&quot;</span><span class="p">)</span>
    <span class="n">s</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">player_laser</span> <span class="o">=</span> <span class="n">load_image</span><span class="p">(</span><span class="s2">&quot;laserBlue03.png&quot;</span><span class="p">)</span>
    <span class="n">s</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">player_laser_sound</span> <span class="o">=</span> <span class="n">load_sound</span><span class="p">(</span><span class="s2">&quot;laserRetro_000.ogg&quot;</span><span class="p">)</span>
    <span class="n">s</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">enemy_laser_sound</span> <span class="o">=</span> <span class="n">load_sound</span><span class="p">(</span><span class="s2">&quot;laserRetro_004.ogg&quot;</span><span class="p">)</span>
    <span class="n">s</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">explosion_sound</span> <span class="o">=</span> <span class="n">load_sound</span><span class="p">(</span><span class="s2">&quot;explosionCrunch_000.ogg&quot;</span><span class="p">)</span>
    <span class="n">s</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">loaded</span> <span class="o">=</span> <span class="kc">True</span>

<span class="k">def</span> <span class="nf">del_state</span><span class="p">(</span><span class="n">current</span><span class="p">:</span> <span class="n">utils</span><span class="o">.</span><span class="n">Data</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">s</span><span class="p">:</span> <span class="n">State</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;State&quot;</span><span class="p">,</span> <span class="n">current</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">loaded</span><span class="p">:</span>
        <span class="n">rl</span><span class="o">.</span><span class="n">unload_texture</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">player</span><span class="p">)</span>
        <span class="n">rl</span><span class="o">.</span><span class="n">unload_texture</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">enemy1</span><span class="p">)</span>
        <span class="n">rl</span><span class="o">.</span><span class="n">unload_texture</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">enemy2</span><span class="p">)</span>
        <span class="n">rl</span><span class="o">.</span><span class="n">unload_texture</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">enemy3</span><span class="p">)</span>
        <span class="n">rl</span><span class="o">.</span><span class="n">unload_texture</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">enemy4</span><span class="p">)</span>
        <span class="n">rl</span><span class="o">.</span><span class="n">unload_texture</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">enemy5</span><span class="p">)</span>
        <span class="n">rl</span><span class="o">.</span><span class="n">unload_texture</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">enemy_laser</span><span class="p">)</span>
        <span class="n">rl</span><span class="o">.</span><span class="n">unload_texture</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">player_laser</span><span class="p">)</span>
        <span class="n">rl</span><span class="o">.</span><span class="n">unload_sound</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">player_laser_sound</span><span class="p">)</span>
        <span class="n">rl</span><span class="o">.</span><span class="n">unload_sound</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">enemy_laser_sound</span><span class="p">)</span>
        <span class="n">rl</span><span class="o">.</span><span class="n">unload_sound</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">explosion_sound</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">s</span><span class="o">.</span><span class="n">enemies</span>
    <span class="k">del</span> <span class="n">s</span><span class="o">.</span><span class="n">stars</span>
    <span class="k">del</span> <span class="n">s</span><span class="o">.</span><span class="n">assets</span>
    <span class="k">del</span> <span class="n">s</span><span class="o">.</span><span class="n">player_bullets</span>
    <span class="k">del</span> <span class="n">s</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">s</span><span class="p">:</span> <span class="n">State</span> <span class="o">=</span> <span class="n">init_state</span><span class="p">()</span>
    <span class="n">s</span><span class="o">.</span><span class="n">scene</span> <span class="o">=</span> <span class="n">SCENE_TITLE</span>
    <span class="n">rl</span><span class="o">.</span><span class="n">init_window</span><span class="p">(</span><span class="n">GAME_W</span><span class="p">,</span> <span class="n">GAME_H</span><span class="p">,</span> <span class="s2">&quot;Space blast&quot;</span><span class="p">)</span>
    <span class="n">rl</span><span class="o">.</span><span class="n">set_target_fps</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
    <span class="n">rl</span><span class="o">.</span><span class="n">init_audio_device</span><span class="p">()</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">rl</span><span class="o">.</span><span class="n">window_should_close</span><span class="p">():</span>
        <span class="n">game_step</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="s2">&quot;utils.Data&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span>
    <span class="n">del_state</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="s2">&quot;utils.Data&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span>
    <span class="n">rl</span><span class="o">.</span><span class="n">close_audio_device</span><span class="p">()</span>
    <span class="n">rl</span><span class="o">.</span><span class="n">close_window</span><span class="p">()</span>
    <span class="k">return</span> <span class="mi">0</span>

<span class="c1"># ------------ Utilities -----------</span>

<span class="k">def</span> <span class="nf">load_image</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">rl</span><span class="o">.</span><span class="n">Texture2D</span><span class="p">:</span>
    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;assets/img/&quot;</span> <span class="o">+</span> <span class="n">s</span>
    <span class="k">return</span> <span class="n">rl</span><span class="o">.</span><span class="n">load_texture</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">load_sound</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">rl</span><span class="o">.</span><span class="n">Sound</span><span class="p">:</span>
    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;assets/audio/&quot;</span> <span class="o">+</span> <span class="n">s</span>
    <span class="k">return</span> <span class="n">rl</span><span class="o">.</span><span class="n">load_sound</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">draw_image</span><span class="p">(</span><span class="n">img</span><span class="p">:</span> <span class="n">rl</span><span class="o">.</span><span class="n">Texture2D</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">w</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;int&quot;</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">width</span><span class="p">)</span>
    <span class="n">h</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;int&quot;</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>
    <span class="n">rl</span><span class="o">.</span><span class="n">draw_texture</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">x</span> <span class="o">-</span> <span class="n">w</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">y</span> <span class="o">-</span> <span class="n">h</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">rl</span><span class="o">.</span><span class="n">color</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">rectangle</span><span class="p">(</span><span class="n">img</span><span class="p">:</span> <span class="n">rl</span><span class="o">.</span><span class="n">Texture2D</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">rl</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">:</span>
    <span class="n">w</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;int&quot;</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">width</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span>
    <span class="n">h</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;int&quot;</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">height</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span>
    <span class="n">actual_x</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;float&quot;</span><span class="p">,</span> <span class="n">x</span> <span class="o">-</span> <span class="n">w</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1.0f</span>
    <span class="n">actual_y</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;float&quot;</span><span class="p">,</span> <span class="n">y</span> <span class="o">-</span> <span class="n">h</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1.0f</span>
    <span class="k">return</span> <span class="n">rl</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">actual_x</span><span class="p">,</span> <span class="n">actual_y</span><span class="p">,</span> <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;float&quot;</span><span class="p">,</span> <span class="n">w</span><span class="p">),</span> <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;float&quot;</span><span class="p">,</span> <span class="n">h</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">collides</span><span class="p">(</span><span class="n">img1</span><span class="p">:</span> <span class="n">rl</span><span class="o">.</span><span class="n">Texture2D</span><span class="p">,</span> <span class="n">x1</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">y1</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">img2</span><span class="p">:</span> <span class="n">rl</span><span class="o">.</span><span class="n">Texture2D</span><span class="p">,</span> <span class="n">x2</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">y2</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">rl</span><span class="o">.</span><span class="n">check_collision_recs</span><span class="p">(</span><span class="n">rectangle</span><span class="p">(</span><span class="n">img1</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">),</span> <span class="n">rectangle</span><span class="p">(</span><span class="n">img2</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">get_enemy_ship</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="n">State</span><span class="p">,</span> <span class="n">asset</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">rl</span><span class="o">.</span><span class="n">Texture2D</span><span class="p">:</span>
    <span class="n">enemy</span><span class="p">:</span> <span class="n">rl</span><span class="o">.</span><span class="n">Texture2D</span>
    <span class="k">if</span> <span class="n">asset</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">enemy</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">enemy1</span>
    <span class="k">if</span> <span class="n">asset</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">enemy</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">enemy2</span>
    <span class="k">if</span> <span class="n">asset</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">enemy</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">enemy3</span>
    <span class="k">if</span> <span class="n">asset</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">enemy</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">enemy4</span>
    <span class="k">if</span> <span class="n">asset</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
        <span class="n">enemy</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">enemy5</span>
    <span class="k">return</span> <span class="n">enemy</span>
</pre></div></details></div><div class="note"></div></div><div class="box"><div class="content"><a href="/static_demos/space_blast/space_blast.html"target="_blank">Show demo in a new tab</a><details open><summary>Show demo inline</summary><iframe src="/static_demos/space_blast/space_blast.html"width="100%"height="700px"style="border:none">&nbsp</iframe></details></div><div class="note"></div></div><div class="box"><div class="content"><hr></div><div class="note"><hr></div></div><div class="box"><div class="content"><h2 id="gui-demo">GUI Demo</h2><span class="timestamp">Created 2023-08-13, Last Updated 2023-08-13</span></div><div class="note"></div></div><div class="box"><div class="content"><p>Try pressing the counter buttons below</div><div class="note"></div></div><div class="box"><div class="content"><details open><summary>Code</summary><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">raylib</span> <span class="k">as</span> <span class="nn">rl</span>
<span class="kn">import</span> <span class="nn">raylib.utils</span>
<span class="kn">import</span> <span class="nn">raylib.gui</span>
<span class="kn">import</span> <span class="nn">libs.numbers</span> <span class="k">as</span> <span class="nn">num</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">width</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="n">height</span> <span class="o">=</span> <span class="mi">160</span>
    <span class="n">counter1</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">counter2</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">rl</span><span class="o">.</span><span class="n">init_window</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="s2">&quot;Counter&quot;</span><span class="p">)</span>
    <span class="n">rl</span><span class="o">.</span><span class="n">set_target_fps</span><span class="p">(</span><span class="mi">120</span><span class="p">)</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">rl</span><span class="o">.</span><span class="n">window_should_close</span><span class="p">():</span>
        <span class="n">rl</span><span class="o">.</span><span class="n">begin_drawing</span><span class="p">()</span>
        <span class="n">rl</span><span class="o">.</span><span class="n">clear_background</span><span class="p">(</span><span class="n">rl</span><span class="o">.</span><span class="n">color</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span>
        <span class="n">gui</span><span class="o">.</span><span class="n">gui_panel</span><span class="p">(</span><span class="n">rl</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="mf">10.0f</span><span class="p">,</span> <span class="mf">10.0f</span><span class="p">,</span> <span class="n">num</span><span class="o">.</span><span class="n">i2f</span><span class="p">(</span><span class="n">width</span><span class="p">)</span> <span class="o">-</span> <span class="mf">20.0f</span><span class="p">,</span> <span class="n">num</span><span class="o">.</span><span class="n">i2f</span><span class="p">(</span><span class="n">height</span><span class="p">)</span> <span class="o">-</span> <span class="mf">20.0f</span><span class="p">),</span> <span class="s2">&quot;&lt;Counter&gt;&quot;</span><span class="p">)</span>
        <span class="n">widget_width</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">i2f</span><span class="p">(</span><span class="n">width</span><span class="p">)</span> <span class="o">-</span> <span class="mf">40.0f</span>
        <span class="c1"># Counter 1</span>
        <span class="n">gui</span><span class="o">.</span><span class="n">gui_label</span><span class="p">(</span><span class="n">rl</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="mf">20.0f</span><span class="p">,</span> <span class="mf">40.0f</span><span class="p">,</span> <span class="n">widget_width</span><span class="p">,</span> <span class="mf">20.0f</span><span class="p">),</span> <span class="s2">&quot;Count:&quot;</span> <span class="o">+</span> <span class="n">num</span><span class="o">.</span><span class="n">i2s</span><span class="p">(</span><span class="n">counter1</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">gui</span><span class="o">.</span><span class="n">gui_button</span><span class="p">(</span><span class="n">rl</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="mf">20.0f</span><span class="p">,</span> <span class="mf">60.0f</span><span class="p">,</span> <span class="n">widget_width</span><span class="p">,</span> <span class="mf">20.0f</span><span class="p">),</span> <span class="s2">&quot;Count&quot;</span><span class="p">):</span>
            <span class="n">counter1</span> <span class="o">=</span> <span class="n">counter1</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="c1"># Counter 2</span>
        <span class="n">gui</span><span class="o">.</span><span class="n">gui_label</span><span class="p">(</span><span class="n">rl</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="mf">20.0f</span><span class="p">,</span> <span class="mf">80.0f</span><span class="p">,</span> <span class="n">widget_width</span><span class="p">,</span> <span class="mf">20.0f</span><span class="p">),</span> <span class="s2">&quot;Count:&quot;</span> <span class="o">+</span> <span class="n">num</span><span class="o">.</span><span class="n">i2s</span><span class="p">(</span><span class="n">counter2</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">gui</span><span class="o">.</span><span class="n">gui_button</span><span class="p">(</span><span class="n">rl</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="mf">20.0f</span><span class="p">,</span> <span class="mf">100.0f</span><span class="p">,</span> <span class="n">widget_width</span><span class="p">,</span> <span class="mf">20.0f</span><span class="p">),</span> <span class="s2">&quot;Count&quot;</span><span class="p">):</span>
            <span class="n">counter2</span> <span class="o">=</span> <span class="n">counter2</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="c1"># Asciimoji status bar</span>
        <span class="n">animation</span> <span class="o">=</span> <span class="p">(</span><span class="n">counter1</span> <span class="o">+</span> <span class="n">counter2</span><span class="p">)</span> <span class="o">%</span> <span class="mi">3</span>
        <span class="k">if</span> <span class="n">animation</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">gui</span><span class="o">.</span><span class="n">gui_status_bar</span><span class="p">(</span><span class="n">rl</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="mf">10.0f</span><span class="p">,</span> <span class="n">num</span><span class="o">.</span><span class="n">i2f</span><span class="p">(</span><span class="n">height</span><span class="p">)</span> <span class="o">-</span> <span class="mf">30.0f</span><span class="p">,</span> <span class="n">num</span><span class="o">.</span><span class="n">i2f</span><span class="p">(</span><span class="n">width</span><span class="p">)</span> <span class="o">-</span> <span class="mf">20.0f</span><span class="p">,</span> <span class="mf">20.0f</span><span class="p">),</span> <span class="s2">&quot; </span><span class="se">\\</span><span class="s2">- (- _ -) -/&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gui</span><span class="o">.</span><span class="n">gui_status_bar</span><span class="p">(</span><span class="n">rl</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="mf">10.0f</span><span class="p">,</span> <span class="n">num</span><span class="o">.</span><span class="n">i2f</span><span class="p">(</span><span class="n">height</span><span class="p">)</span> <span class="o">-</span> <span class="mf">30.0f</span><span class="p">,</span> <span class="n">num</span><span class="o">.</span><span class="n">i2f</span><span class="p">(</span><span class="n">width</span><span class="p">)</span> <span class="o">-</span> <span class="mf">20.0f</span><span class="p">,</span> <span class="mf">20.0f</span><span class="p">),</span> <span class="s2">&quot; </span><span class="se">\\</span><span class="s2">- (o _ o) -/&quot;</span><span class="p">)</span>
        <span class="n">rl</span><span class="o">.</span><span class="n">draw_fps</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">540</span><span class="p">)</span>
        <span class="n">rl</span><span class="o">.</span><span class="n">end_drawing</span><span class="p">()</span>
    <span class="n">rl</span><span class="o">.</span><span class="n">close_window</span><span class="p">()</span>
    <span class="k">return</span> <span class="mi">0</span>
</pre></div></details></div><div class="note"></div></div><div class="box"><div class="content"><a href="/static_demos/gui/gui_window.html"target="_blank">Show demo in a new tab</a><details open><summary>Show demo inline</summary><iframe src="/static_demos/gui/gui_window.html"width="100%"height="700px"style="border:none">&nbsp</iframe></details></div><div class="note"></div></div><div class="box"><div class="content"><hr></div><div class="note"><hr></div></div><div class="box"><div class="content"><h2 id="wasm4-demo-notes">WASM4 Demo - notes</h2><span class="timestamp">Created 2023-08-13, Last Updated 2023-08-13</span></div><div class="note"></div></div><div class="box"><div class="content"><p>Hint: Something like Nokia ringtone maker for WASM4</div><div class="note"></div></div><div class="box"><div class="content"><details open><summary>Code</summary><div class="highlight"><pre><span></span><span class="c1"># =========================================================================================</span>
<span class="c1">#        ________________________________</span>
<span class="c1">#       /    o   oooo ooo oooo   o o o  /\</span>
<span class="c1">#      /    oo  ooo  oo  oooo   o o o  / /</span>
<span class="c1">#     /    _________________________  / /</span>
<span class="c1">#    / // / // /// // /// // /// / / / /</span>
<span class="c1">#   /___ //////////////////////////_/ /</span>
<span class="c1">#   \____\________________________\_\/</span>
<span class="c1">#</span>
<span class="c1">#  **notes**: Application by -- Bhathiya Perera --</span>
<span class="c1">#        For WASM4 Fantasy Console</span>
<span class="c1">#</span>
<span class="c1"># =========================================================================================</span>
<span class="c1"># ASCII ART by Forrest Cook -- reference https://asciiart.website/index.php?art=music/pianos</span>
<span class="c1"># Note Frequencies          -- reference https://pages.mtu.edu/~suits/notefreqs.html</span>
<span class="c1"># Nokia composer web app    -- reference https://zserge.com/nokia-composer/h/</span>
<span class="c1"># =========================================================================================</span>
<span class="c1"># Nokia Tune:</span>
<span class="c1"># 3e3 3d3 2f#2 2g#2 3c#3 3b2 2d2 2e2 3b2 3a2 2c#2 2e2 1a2 1R</span>
<span class="c1"># =========================================================================================</span>
<span class="kn">import</span> <span class="nn">w4</span>
<span class="kn">import</span> <span class="nn">libs.numbers</span> <span class="k">as</span> <span class="nn">num</span>
<span class="kn">import</span> <span class="nn">libs.perlin</span>
<span class="kn">import</span> <span class="nn">libs.random</span>
<span class="kn">import</span> <span class="nn">libs.c</span> <span class="k">as</span> <span class="nn">mini_clib</span>

<span class="c1"># Total notes allowed</span>
<span class="n">MAX_NOTES</span>       <span class="p">:</span><span class="nb">Const</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">256</span>
<span class="n">FONT_WIDTH</span>      <span class="p">:</span><span class="nb">Const</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">NOTE_WRAP_AROUND</span><span class="p">:</span><span class="nb">Const</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">55</span>
<span class="c1"># ======= Notes ===========</span>
<span class="n">NOTE_C</span><span class="p">:</span>   <span class="nb">Const</span><span class="p">[</span><span class="nb">u8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1u8</span>
<span class="n">NOTE_C_S</span><span class="p">:</span> <span class="nb">Const</span><span class="p">[</span><span class="nb">u8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2u8</span>
<span class="n">NOTE_D</span><span class="p">:</span>   <span class="nb">Const</span><span class="p">[</span><span class="nb">u8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3u8</span>
<span class="n">NOTE_D_S</span><span class="p">:</span> <span class="nb">Const</span><span class="p">[</span><span class="nb">u8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4u8</span>
<span class="n">NOTE_E</span><span class="p">:</span>   <span class="nb">Const</span><span class="p">[</span><span class="nb">u8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5u8</span>
<span class="n">NOTE_F</span><span class="p">:</span>   <span class="nb">Const</span><span class="p">[</span><span class="nb">u8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6u8</span>
<span class="n">NOTE_F_S</span><span class="p">:</span> <span class="nb">Const</span><span class="p">[</span><span class="nb">u8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">7u8</span>
<span class="n">NOTE_G</span><span class="p">:</span>   <span class="nb">Const</span><span class="p">[</span><span class="nb">u8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8u8</span>
<span class="n">NOTE_G_S</span><span class="p">:</span> <span class="nb">Const</span><span class="p">[</span><span class="nb">u8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">9u8</span>
<span class="n">NOTE_A</span><span class="p">:</span>   <span class="nb">Const</span><span class="p">[</span><span class="nb">u8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10u8</span>
<span class="n">NOTE_A_S</span><span class="p">:</span> <span class="nb">Const</span><span class="p">[</span><span class="nb">u8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">11u8</span>
<span class="n">NOTE_B</span><span class="p">:</span>   <span class="nb">Const</span><span class="p">[</span><span class="nb">u8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">12u8</span>
<span class="n">NOTE_REST</span><span class="p">:</span><span class="nb">Const</span><span class="p">[</span><span class="nb">u8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">13u8</span>
<span class="c1"># Play until we find this</span>
<span class="n">NOTE_NULL</span><span class="p">:</span><span class="nb">Const</span><span class="p">[</span><span class="nb">u8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0u8</span>

<span class="c1"># ======= Notes Time ======</span>
<span class="c1"># 1/pow(2, TIME)</span>
<span class="n">TIME_64</span><span class="p">:</span>  <span class="nb">Const</span><span class="p">[</span><span class="nb">u8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6u8</span>
<span class="n">TIME_32</span><span class="p">:</span>  <span class="nb">Const</span><span class="p">[</span><span class="nb">u8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5u8</span>
<span class="n">TIME_16</span><span class="p">:</span>  <span class="nb">Const</span><span class="p">[</span><span class="nb">u8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4u8</span>
<span class="n">TIME_8</span><span class="p">:</span>   <span class="nb">Const</span><span class="p">[</span><span class="nb">u8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3u8</span>
<span class="n">TIME_4</span><span class="p">:</span>   <span class="nb">Const</span><span class="p">[</span><span class="nb">u8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2u8</span>
<span class="n">TIME_HALF</span><span class="p">:</span><span class="nb">Const</span><span class="p">[</span><span class="nb">u8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1u8</span>
<span class="n">TIME_FULL</span><span class="p">:</span><span class="nb">Const</span><span class="p">[</span><span class="nb">u8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0u8</span>

<span class="c1"># ====Note Octaves ========</span>
<span class="n">OCTAVE_1</span> <span class="p">:</span><span class="nb">Const</span><span class="p">[</span><span class="nb">u8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0u8</span>
<span class="n">OCTAVE_2</span> <span class="p">:</span><span class="nb">Const</span><span class="p">[</span><span class="nb">u8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1u8</span>
<span class="n">OCTAVE_3</span> <span class="p">:</span><span class="nb">Const</span><span class="p">[</span><span class="nb">u8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2u8</span>

<span class="c1"># == Editing Modes ========</span>
<span class="n">MODE_TIME</span><span class="p">:</span><span class="nb">Const</span><span class="p">[</span><span class="nb">u8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0u8</span>
<span class="n">MODE_NOTE</span><span class="p">:</span><span class="nb">Const</span><span class="p">[</span><span class="nb">u8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1u8</span>
<span class="n">MODE_OCT</span> <span class="p">:</span><span class="nb">Const</span><span class="p">[</span><span class="nb">u8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2u8</span>
<span class="n">MODE_DEL</span> <span class="p">:</span><span class="nb">Const</span><span class="p">[</span><span class="nb">u8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3u8</span>
<span class="c1"># max, min mode</span>
<span class="n">TOTAL_MODES</span> <span class="p">:</span><span class="nb">Const</span><span class="p">[</span><span class="nb">u8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4u8</span>


<span class="k">class</span> <span class="nc">State</span><span class="p">:</span>
    <span class="n">width</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">height</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">frame_count</span><span class="p">:</span> <span class="nb">u64</span>
    <span class="n">gamepad_prev</span><span class="p">:</span> <span class="nb">u8</span>
    <span class="n">text_buf</span><span class="p">:</span> <span class="nb">Array</span><span class="p">[</span><span class="nb">u8</span><span class="p">]</span>
    <span class="c1"># Tuple [u8 - time, u8 - note, u8 - octave, u8 - extra]</span>
    <span class="n">note_buf</span><span class="p">:</span> <span class="nb">Array</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">u8</span><span class="p">,</span><span class="nb">u8</span><span class="p">,</span><span class="nb">u8</span><span class="p">,</span><span class="nb">u8</span><span class="p">]]</span>
    <span class="n">note_freq</span><span class="p">:</span> <span class="nb">Array</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
    <span class="n">note_time</span><span class="p">:</span> <span class="nb">Array</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
    <span class="c1"># Cursor position</span>
    <span class="n">cursor</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">prev_cursor</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">v_start</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">v_end</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">note_count</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">mode</span><span class="p">:</span> <span class="nb">u8</span>
    <span class="n">playing</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">play_on</span><span class="p">:</span> <span class="nb">u64</span>

<span class="k">def</span> <span class="nf">clear_buf</span><span class="p">(</span><span class="n">target</span><span class="p">:</span> <span class="nb">Array</span><span class="p">[</span><span class="nb">u8</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">target</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0u8</span>
    <span class="n">target</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0u8</span>
    <span class="n">target</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0u8</span>
    <span class="n">target</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0u8</span>
    <span class="n">target</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0u8</span>
    <span class="n">target</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0u8</span>
    <span class="n">target</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0u8</span>
    <span class="n">target</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0u8</span>
    <span class="n">target</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0u8</span>
    <span class="n">target</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0u8</span>
    <span class="n">target</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0u8</span>

<span class="k">def</span> <span class="nf">i2s</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="nb">Array</span><span class="p">[</span><span class="nb">u8</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="c1"># Convert given integer to a string</span>
    <span class="c1"># Support up to 10 character output (size 11 buffer is required)</span>
    <span class="n">charset</span><span class="p">:</span> <span class="nb">Ptr</span><span class="p">[</span><span class="nb">Const</span><span class="p">[</span><span class="nb">u8</span><span class="p">]]</span> <span class="o">=</span> <span class="n">binarydata</span><span class="p">(</span><span class="s2">&quot;0123456789- </span><span class="se">\0</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">clear_buf</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
    <span class="n">pos</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">y</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">9999999999</span> <span class="ow">or</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">999999999</span><span class="p">:</span>
        <span class="n">target</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;u8&quot;</span><span class="p">,</span> <span class="nb">charat</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="s2">&quot;str&quot;</span><span class="p">,</span> <span class="n">charset</span><span class="p">),</span> <span class="mi">10</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">y</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">target</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;u8&quot;</span><span class="p">,</span> <span class="nb">charat</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="s2">&quot;str&quot;</span><span class="p">,</span> <span class="n">charset</span><span class="p">),</span> <span class="mi">10</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">target</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;u8&quot;</span><span class="p">,</span> <span class="nb">charat</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="s2">&quot;str&quot;</span><span class="p">,</span> <span class="n">charset</span><span class="p">),</span> <span class="mi">11</span><span class="p">))</span>
    <span class="n">pos</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">y</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">target</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;u8&quot;</span><span class="p">,</span> <span class="nb">charat</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="s2">&quot;str&quot;</span><span class="p">,</span> <span class="n">charset</span><span class="p">),</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">pos</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="n">y</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">character</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">y</span> <span class="o">%</span> <span class="mi">10</span>
        <span class="n">target</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;u8&quot;</span><span class="p">,</span> <span class="nb">charat</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="s2">&quot;str&quot;</span><span class="p">,</span> <span class="n">charset</span><span class="p">),</span> <span class="n">character</span><span class="p">))</span>
        <span class="n">pos</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">y</span> <span class="o">/=</span> <span class="mi">10</span>
    <span class="c1"># Reverse from 1 to pos</span>
    <span class="n">rpos</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">rmax</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="p">(</span><span class="n">pos</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="n">rpos</span> <span class="o">&lt;</span> <span class="n">rmax</span><span class="p">:</span>
        <span class="n">temp</span><span class="p">:</span> <span class="nb">u8</span> <span class="o">=</span> <span class="n">target</span><span class="p">[</span><span class="n">rpos</span><span class="p">]</span>
        <span class="n">target</span><span class="p">[</span><span class="n">rpos</span><span class="p">]</span> <span class="o">=</span> <span class="n">target</span><span class="p">[</span><span class="n">pos</span> <span class="o">-</span> <span class="n">rpos</span><span class="p">]</span>
        <span class="n">target</span><span class="p">[</span><span class="n">pos</span> <span class="o">-</span> <span class="n">rpos</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span>
        <span class="n">rpos</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="kc">True</span>

<span class="k">def</span> <span class="nf">del_note</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="n">State</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">note_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">x</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">cursor</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">last</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">note_count</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="n">last</span><span class="p">:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">last</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">NOTE_NULL</span>
    <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">last</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">NOTE_NULL</span>
    <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">last</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">NOTE_NULL</span>
    <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">last</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">NOTE_NULL</span>
    <span class="n">s</span><span class="o">.</span><span class="n">note_count</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">cursor</span> <span class="o">&gt;=</span> <span class="n">s</span><span class="o">.</span><span class="n">note_count</span><span class="p">:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">note_count</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">cursor</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">add_left</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="n">State</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="c1"># We are full</span>
    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">note_count</span> <span class="o">==</span> <span class="n">MAX_NOTES</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">note_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">TIME_4</span>
        <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">NOTE_C</span>
        <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">OCTAVE_2</span>
        <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0u8</span>
        <span class="n">s</span><span class="o">.</span><span class="n">note_count</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">s</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span>
    <span class="c1"># Add at cursor location + 1</span>
    <span class="c1"># Move everything from right most to + 1 position</span>
    <span class="n">x</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">note_count</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="n">s</span><span class="o">.</span><span class="n">cursor</span><span class="p">:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">cursor</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">TIME_4</span>
    <span class="c1"># Alternatively add note c and note rest</span>
    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">note_count</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">cursor</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">NOTE_C</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">cursor</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">NOTE_REST</span>
    <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">cursor</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">OCTAVE_2</span>
    <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">cursor</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0u8</span>
    <span class="n">s</span><span class="o">.</span><span class="n">note_count</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="k">def</span> <span class="nf">add_right</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="n">State</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="c1"># We are full</span>
    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">note_count</span> <span class="o">==</span> <span class="n">MAX_NOTES</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">note_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">TIME_4</span>
        <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">NOTE_C</span>
        <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">OCTAVE_2</span>
        <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0u8</span>
        <span class="n">s</span><span class="o">.</span><span class="n">note_count</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">s</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span>
    <span class="c1"># Add at cursor location + 1</span>
    <span class="c1"># Move everything from right most to + 1 position</span>
    <span class="n">x</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">note_count</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="n">s</span><span class="o">.</span><span class="n">cursor</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">cursor</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">TIME_4</span>
    <span class="c1"># Alternatively add note c and note rest</span>
    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">note_count</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">cursor</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">NOTE_C</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">cursor</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">NOTE_REST</span>
    <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">cursor</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">OCTAVE_2</span>
    <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">cursor</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0u8</span>
    <span class="n">s</span><span class="o">.</span><span class="n">note_count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">s</span><span class="o">.</span><span class="n">cursor</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="k">def</span> <span class="nf">up_note</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="n">State</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">note_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MODE_TIME</span><span class="p">:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">cursor</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1u8</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">cursor</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">TIME_64</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">cursor</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">TIME_FULL</span>
    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MODE_NOTE</span><span class="p">:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">cursor</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1u8</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">cursor</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">NOTE_REST</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">cursor</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">NOTE_C</span>
    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MODE_OCT</span><span class="p">:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">cursor</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1u8</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">cursor</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">OCTAVE_3</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">cursor</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">OCTAVE_1</span>

<span class="k">def</span> <span class="nf">down_note</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="n">State</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">note_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MODE_TIME</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">cursor</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">TIME_FULL</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">cursor</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">TIME_64</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">cursor</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1u8</span>
    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MODE_NOTE</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">cursor</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">NOTE_C</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">cursor</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">NOTE_REST</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">cursor</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1u8</span>
    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MODE_OCT</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">cursor</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">OCTAVE_1</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">cursor</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">OCTAVE_3</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">cursor</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1u8</span>

<span class="k">def</span> <span class="nf">handle_input</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="n">State</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">just_pressed</span><span class="p">:</span> <span class="nb">u8</span> <span class="o">=</span> <span class="n">w4</span><span class="o">.</span><span class="n">gamepad1</span><span class="p">()</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">w4</span><span class="o">.</span><span class="n">gamepad1</span><span class="p">()</span> <span class="o">^</span> <span class="n">s</span><span class="o">.</span><span class="n">gamepad_prev</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">just_pressed</span> <span class="o">&amp;</span> <span class="n">w4</span><span class="o">.</span><span class="n">BUTTON_2</span> <span class="o">!=</span> <span class="mi">0u8</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">playing</span><span class="p">:</span>
            <span class="c1"># Stop</span>
            <span class="n">s</span><span class="o">.</span><span class="n">playing</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">s</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">prev_cursor</span>
            <span class="n">s</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">MODE_NOTE</span>
        <span class="k">elif</span> <span class="n">w4</span><span class="o">.</span><span class="n">gamepad1</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">w4</span><span class="o">.</span><span class="n">BUTTON_1</span> <span class="o">!=</span> <span class="mi">0u8</span><span class="p">:</span>
            <span class="c1"># Play</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">note_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">s</span><span class="o">.</span><span class="n">prev_cursor</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">cursor</span>
            <span class="n">s</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">s</span><span class="o">.</span><span class="n">playing</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">s</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MODE_DEL</span><span class="p">:</span>
            <span class="c1"># Delete</span>
            <span class="n">del_note</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">s</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MODE_OCT</span><span class="p">:</span>
            <span class="c1"># Add left</span>
            <span class="n">add_left</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">add_right</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="c1"># Only if we are not playing</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="o">.</span><span class="n">playing</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">just_pressed</span> <span class="o">&amp;</span> <span class="n">w4</span><span class="o">.</span><span class="n">BUTTON_1</span> <span class="o">!=</span> <span class="mi">0u8</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">mode</span> <span class="o">+=</span> <span class="mi">1u8</span>
            <span class="n">s</span><span class="o">.</span><span class="n">mode</span> <span class="o">%=</span> <span class="n">TOTAL_MODES</span>
        <span class="k">if</span> <span class="n">just_pressed</span> <span class="o">&amp;</span> <span class="n">w4</span><span class="o">.</span><span class="n">BUTTON_UP</span> <span class="o">!=</span> <span class="mi">0u8</span><span class="p">:</span>
            <span class="n">up_note</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">just_pressed</span> <span class="o">&amp;</span> <span class="n">w4</span><span class="o">.</span><span class="n">BUTTON_DOWN</span> <span class="o">!=</span> <span class="mi">0u8</span><span class="p">:</span>
            <span class="n">down_note</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">just_pressed</span> <span class="o">&amp;</span> <span class="n">w4</span><span class="o">.</span><span class="n">BUTTON_LEFT</span> <span class="o">!=</span> <span class="mi">0u8</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">cursor</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="c1"># Wrap around</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">cursor</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">note_count</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">just_pressed</span> <span class="o">&amp;</span> <span class="n">w4</span><span class="o">.</span><span class="n">BUTTON_RIGHT</span> <span class="o">!=</span> <span class="mi">0u8</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">cursor</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1"># Wrap around</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">cursor</span> <span class="o">&gt;</span> <span class="n">s</span><span class="o">.</span><span class="n">note_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">s</span><span class="o">.</span><span class="n">gamepad_prev</span> <span class="o">=</span> <span class="n">w4</span><span class="o">.</span><span class="n">gamepad1</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">draw_board</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="n">State</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">w4</span><span class="o">.</span><span class="n">set_draw_colors</span><span class="p">(</span><span class="mh">0x0014</span><span class="nb">u16</span><span class="p">)</span>
    <span class="n">w4</span><span class="o">.</span><span class="n">text_u8</span><span class="p">(</span><span class="n">binarydata</span><span class="p">(</span><span class="s2">&quot;mode:</span><span class="se">\0</span><span class="s2">&quot;</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">i2s</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">note_count</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">text_buf</span><span class="p">)</span>
    <span class="n">w4</span><span class="o">.</span><span class="n">text_u8</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="s2">&quot;Ptr[Const[u8]]&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">text_buf</span><span class="p">),</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">w4</span><span class="o">.</span><span class="n">vline</span><span class="p">(</span><span class="mi">118</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10u32</span><span class="p">)</span>
    <span class="n">w4</span><span class="o">.</span><span class="n">vline</span><span class="p">(</span><span class="mi">79</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10u32</span><span class="p">)</span>
    <span class="n">w4</span><span class="o">.</span><span class="n">set_draw_colors</span><span class="p">(</span><span class="mh">0x0012</span><span class="nb">u16</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">note_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">i2s</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">text_buf</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">i2s</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">cursor</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">text_buf</span><span class="p">)</span>
    <span class="n">w4</span><span class="o">.</span><span class="n">text_u8</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="s2">&quot;Ptr[Const[u8]]&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">text_buf</span><span class="p">),</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">w4</span><span class="o">.</span><span class="n">hline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">160u32</span><span class="p">)</span>
    <span class="n">w4</span><span class="o">.</span><span class="n">hline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">height</span> <span class="o">-</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">160u32</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">playing</span><span class="p">:</span>
        <span class="n">w4</span><span class="o">.</span><span class="n">text_u8</span><span class="p">(</span><span class="n">binarydata</span><span class="p">(</span><span class="s2">&quot;play</span><span class="se">\0</span><span class="s2">&quot;</span><span class="p">),</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">w4</span><span class="o">.</span><span class="n">text_u8</span><span class="p">(</span><span class="n">binarydata</span><span class="p">(</span><span class="s2">&quot;stop</span><span class="se">\0</span><span class="s2">&quot;</span><span class="p">),</span> <span class="mi">55</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">height</span> <span class="o">-</span> <span class="mi">10</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">s</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MODE_TIME</span><span class="p">:</span>
        <span class="n">w4</span><span class="o">.</span><span class="n">text_u8</span><span class="p">(</span><span class="n">binarydata</span><span class="p">(</span><span class="s2">&quot;time</span><span class="se">\0</span><span class="s2">&quot;</span><span class="p">),</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">w4</span><span class="o">.</span><span class="n">text_u8</span><span class="p">(</span><span class="n">binarydata</span><span class="p">(</span><span class="s2">&quot;add</span><span class="se">\x85\0</span><span class="s2">&quot;</span><span class="p">),</span> <span class="mi">55</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">height</span> <span class="o">-</span> <span class="mi">10</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">s</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MODE_NOTE</span><span class="p">:</span>
        <span class="n">w4</span><span class="o">.</span><span class="n">text_u8</span><span class="p">(</span><span class="n">binarydata</span><span class="p">(</span><span class="s2">&quot;note</span><span class="se">\0</span><span class="s2">&quot;</span><span class="p">),</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">w4</span><span class="o">.</span><span class="n">text_u8</span><span class="p">(</span><span class="n">binarydata</span><span class="p">(</span><span class="s2">&quot;add</span><span class="se">\x85\0</span><span class="s2">&quot;</span><span class="p">),</span> <span class="mi">55</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">height</span> <span class="o">-</span> <span class="mi">10</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">s</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MODE_OCT</span><span class="p">:</span>
        <span class="n">w4</span><span class="o">.</span><span class="n">text_u8</span><span class="p">(</span><span class="n">binarydata</span><span class="p">(</span><span class="s2">&quot;octa</span><span class="se">\0</span><span class="s2">&quot;</span><span class="p">),</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">w4</span><span class="o">.</span><span class="n">text_u8</span><span class="p">(</span><span class="n">binarydata</span><span class="p">(</span><span class="s2">&quot;add</span><span class="se">\x84\0</span><span class="s2">&quot;</span><span class="p">),</span> <span class="mi">55</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">height</span> <span class="o">-</span> <span class="mi">10</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">s</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MODE_DEL</span><span class="p">:</span>
        <span class="n">w4</span><span class="o">.</span><span class="n">set_draw_colors</span><span class="p">(</span><span class="mh">0x0013</span><span class="nb">u16</span><span class="p">)</span>
        <span class="n">w4</span><span class="o">.</span><span class="n">text_u8</span><span class="p">(</span><span class="n">binarydata</span><span class="p">(</span><span class="s2">&quot;del </span><span class="se">\0</span><span class="s2">&quot;</span><span class="p">),</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">w4</span><span class="o">.</span><span class="n">text_u8</span><span class="p">(</span><span class="n">binarydata</span><span class="p">(</span><span class="s2">&quot;del </span><span class="se">\0</span><span class="s2">&quot;</span><span class="p">),</span> <span class="mi">55</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">height</span> <span class="o">-</span> <span class="mi">10</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">w4</span><span class="o">.</span><span class="n">set_draw_colors</span><span class="p">(</span><span class="mh">0x0014</span><span class="nb">u16</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="o">.</span><span class="n">playing</span><span class="p">:</span>
        <span class="n">w4</span><span class="o">.</span><span class="n">text_u8</span><span class="p">(</span><span class="n">binarydata</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\x80\0</span><span class="s2">&quot;</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">height</span> <span class="o">-</span> <span class="mi">10</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">w4</span><span class="o">.</span><span class="n">text_u8</span><span class="p">(</span><span class="n">binarydata</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\x81\0</span><span class="s2">&quot;</span><span class="p">),</span> <span class="mi">45</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">height</span> <span class="o">-</span> <span class="mi">10</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="o">.</span><span class="n">playing</span><span class="p">:</span>
        <span class="n">w4</span><span class="o">.</span><span class="n">text_u8</span><span class="p">(</span><span class="n">binarydata</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\x80</span><span class="s2">+</span><span class="se">\x81\0</span><span class="s2">&quot;</span><span class="p">),</span> <span class="mi">88</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">height</span> <span class="o">-</span> <span class="mi">10</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">w4</span><span class="o">.</span><span class="n">set_draw_colors</span><span class="p">(</span><span class="mh">0x0012</span><span class="nb">u16</span><span class="p">)</span>
        <span class="n">w4</span><span class="o">.</span><span class="n">text_u8</span><span class="p">(</span><span class="n">binarydata</span><span class="p">(</span><span class="s2">&quot;mode</span><span class="se">\0</span><span class="s2">&quot;</span><span class="p">),</span> <span class="mi">12</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">height</span> <span class="o">-</span> <span class="mi">10</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="o">.</span><span class="n">playing</span><span class="p">:</span>
        <span class="n">w4</span><span class="o">.</span><span class="n">text_u8</span><span class="p">(</span><span class="n">binarydata</span><span class="p">(</span><span class="s2">&quot;play</span><span class="se">\0</span><span class="s2">&quot;</span><span class="p">),</span> <span class="mi">114</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">height</span> <span class="o">-</span> <span class="mi">10</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">draw_note</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="n">State</span><span class="p">,</span> <span class="n">grid_pos</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">note_pos</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">cursor</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">note_data</span><span class="p">:</span> <span class="nb">Array</span><span class="p">[</span><span class="nb">u8</span><span class="p">]</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;Array[u8]&quot;</span><span class="p">,</span> <span class="n">binarydata</span><span class="p">(</span><span class="s2">&quot;cdefgabR#0&quot;</span><span class="p">))</span>
    <span class="c1"># Do not draw empty notes</span>
    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">note_pos</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">NOTE_NULL</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">x</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="n">grid_pos</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="mi">40</span>
    <span class="n">y</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">12</span> <span class="o">+</span> <span class="p">(</span><span class="n">grid_pos</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span>
    <span class="n">x_delta</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">clear_buf</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">text_buf</span><span class="p">)</span>
    <span class="c1"># Put the time indicator to the buffer</span>
    <span class="n">s</span><span class="o">.</span><span class="n">text_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">note_data</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">+</span> <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">note_pos</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">cursor</span><span class="p">:</span>
        <span class="n">w4</span><span class="o">.</span><span class="n">set_draw_colors</span><span class="p">(</span><span class="mh">0x0042</span><span class="nb">u16</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">w4</span><span class="o">.</span><span class="n">set_draw_colors</span><span class="p">(</span><span class="mh">0x0012</span><span class="nb">u16</span><span class="p">)</span>
    <span class="n">w4</span><span class="o">.</span><span class="n">text_u8</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="s2">&quot;Ptr[Const[u8]]&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">text_buf</span><span class="p">),</span> <span class="n">x</span> <span class="o">+</span> <span class="n">x_delta</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">x_delta</span> <span class="o">+=</span> <span class="n">FONT_WIDTH</span>
    <span class="c1"># Put note indicator</span>
    <span class="n">note</span><span class="p">:</span> <span class="nb">u8</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">note_pos</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">note</span> <span class="o">==</span> <span class="n">NOTE_C</span> <span class="ow">or</span> <span class="n">note</span> <span class="o">==</span> <span class="n">NOTE_C_S</span><span class="p">:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">text_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">note_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">note</span> <span class="o">==</span> <span class="n">NOTE_D</span> <span class="ow">or</span> <span class="n">note</span> <span class="o">==</span> <span class="n">NOTE_D_S</span><span class="p">:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">text_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">note_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">note</span> <span class="o">==</span> <span class="n">NOTE_E</span><span class="p">:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">text_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">note_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">note</span> <span class="o">==</span> <span class="n">NOTE_F</span> <span class="ow">or</span> <span class="n">note</span> <span class="o">==</span> <span class="n">NOTE_F_S</span><span class="p">:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">text_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">note_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">note</span> <span class="o">==</span> <span class="n">NOTE_G</span> <span class="ow">or</span> <span class="n">note</span> <span class="o">==</span> <span class="n">NOTE_G_S</span><span class="p">:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">text_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">note_data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">note</span> <span class="o">==</span> <span class="n">NOTE_A</span> <span class="ow">or</span> <span class="n">note</span> <span class="o">==</span> <span class="n">NOTE_A_S</span><span class="p">:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">text_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">note_data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">note</span> <span class="o">==</span> <span class="n">NOTE_B</span><span class="p">:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">text_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">note_data</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">note</span> <span class="o">==</span> <span class="n">NOTE_REST</span><span class="p">:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">text_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">note_data</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">note</span> <span class="o">==</span> <span class="n">NOTE_C_S</span> <span class="ow">or</span> <span class="n">note</span> <span class="o">==</span> <span class="n">NOTE_D_S</span> <span class="ow">or</span> <span class="n">note</span> <span class="o">==</span> <span class="n">NOTE_F_S</span> <span class="ow">or</span> <span class="n">note</span> <span class="o">==</span> <span class="n">NOTE_G_S</span> <span class="ow">or</span> <span class="n">note</span> <span class="o">==</span> <span class="n">NOTE_A_S</span><span class="p">:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">text_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">note_data</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">cursor</span><span class="p">:</span>
        <span class="n">w4</span><span class="o">.</span><span class="n">set_draw_colors</span><span class="p">(</span><span class="mh">0x0043</span><span class="nb">u16</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">w4</span><span class="o">.</span><span class="n">set_draw_colors</span><span class="p">(</span><span class="mh">0x0013</span><span class="nb">u16</span><span class="p">)</span>
    <span class="n">w4</span><span class="o">.</span><span class="n">text_u8</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="s2">&quot;Ptr[Const[u8]]&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">text_buf</span><span class="p">),</span> <span class="n">x</span> <span class="o">+</span> <span class="n">x_delta</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">x_delta</span> <span class="o">+=</span> <span class="n">FONT_WIDTH</span>
    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">text_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0u8</span><span class="p">:</span>
        <span class="c1"># handle &#39;#&#39; sign</span>
        <span class="n">x_delta</span> <span class="o">+=</span> <span class="n">FONT_WIDTH</span>
    <span class="n">s</span><span class="o">.</span><span class="n">text_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0u8</span>
    <span class="c1"># Put octave indicator</span>
    <span class="k">if</span> <span class="n">note</span> <span class="o">!=</span> <span class="n">NOTE_REST</span><span class="p">:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">text_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">note_data</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1u8</span> <span class="o">+</span> <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">note_pos</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">cursor</span><span class="p">:</span>
            <span class="n">w4</span><span class="o">.</span><span class="n">set_draw_colors</span><span class="p">(</span><span class="mh">0x0041</span><span class="nb">u16</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">w4</span><span class="o">.</span><span class="n">set_draw_colors</span><span class="p">(</span><span class="mh">0x0014</span><span class="nb">u16</span><span class="p">)</span>
        <span class="n">w4</span><span class="o">.</span><span class="n">text_u8</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="s2">&quot;Ptr[Const[u8]]&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">text_buf</span><span class="p">),</span> <span class="n">x</span> <span class="o">+</span> <span class="n">x_delta</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">draw_notes</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="n">State</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="c1"># Nothing to draw</span>
    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">note_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">cursor</span> <span class="o">&lt;</span> <span class="n">s</span><span class="o">.</span><span class="n">v_start</span><span class="p">:</span>
        <span class="c1"># moved left</span>
        <span class="n">s</span><span class="o">.</span><span class="n">v_start</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">cursor</span>
        <span class="n">s</span><span class="o">.</span><span class="n">v_end</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">v_start</span> <span class="o">+</span> <span class="n">NOTE_WRAP_AROUND</span>
    <span class="k">elif</span> <span class="n">s</span><span class="o">.</span><span class="n">cursor</span> <span class="o">&gt;</span> <span class="n">s</span><span class="o">.</span><span class="n">v_end</span><span class="p">:</span>
        <span class="c1"># moved right</span>
        <span class="n">s</span><span class="o">.</span><span class="n">v_end</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">cursor</span>
        <span class="n">s</span><span class="o">.</span><span class="n">v_start</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">v_end</span> <span class="o">-</span> <span class="n">NOTE_WRAP_AROUND</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">v_end</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">v_start</span> <span class="o">+</span> <span class="n">NOTE_WRAP_AROUND</span>
    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">v_start</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">v_start</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">v_end</span> <span class="o">&gt;</span> <span class="n">s</span><span class="o">.</span><span class="n">note_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">v_end</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">note_count</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">x</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">v_start</span>
    <span class="n">grid_pos</span><span class="p">:</span> <span class="nb">int</span>  <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">s</span><span class="o">.</span><span class="n">note_count</span> <span class="ow">and</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="n">s</span><span class="o">.</span><span class="n">v_end</span><span class="p">:</span>
        <span class="n">current</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">x</span> <span class="o">==</span> <span class="n">s</span><span class="o">.</span><span class="n">cursor</span>
        <span class="c1"># Show current playing in playing mode</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">playing</span><span class="p">:</span>
            <span class="n">prev</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">prev</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">prev</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">note_count</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">current</span> <span class="o">=</span> <span class="n">prev</span> <span class="o">==</span> <span class="n">s</span><span class="o">.</span><span class="n">cursor</span>
        <span class="n">draw_note</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">grid_pos</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">current</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">grid_pos</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="k">def</span> <span class="nf">play_notes</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="n">State</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="o">.</span><span class="n">playing</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="c1"># Play the next note on nth frame</span>
    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">play_on</span> <span class="o">&gt;</span> <span class="n">s</span><span class="o">.</span><span class="n">frame_count</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">time</span><span class="p">:</span> <span class="nb">u8</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">cursor</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">note</span><span class="p">:</span> <span class="nb">u8</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">cursor</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">octv</span><span class="p">:</span> <span class="nb">u8</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">cursor</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">actual_note</span><span class="p">:</span> <span class="nb">u8</span> <span class="o">=</span> <span class="n">octv</span> <span class="o">*</span> <span class="mi">12u8</span> <span class="o">+</span> <span class="n">note</span>
    <span class="n">note_time</span><span class="p">:</span> <span class="nb">u32</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;u32&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">note_time</span><span class="p">[</span><span class="n">time</span><span class="p">])</span>
    <span class="n">s</span><span class="o">.</span><span class="n">play_on</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">frame_count</span> <span class="o">+</span> <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;u64&quot;</span><span class="p">,</span> <span class="n">note_time</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">note</span> <span class="o">!=</span> <span class="n">NOTE_REST</span><span class="p">:</span>
        <span class="n">note_freq</span><span class="p">:</span> <span class="nb">u32</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;u32&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">note_freq</span><span class="p">[</span><span class="n">actual_note</span><span class="p">])</span>
        <span class="n">w4</span><span class="o">.</span><span class="n">tone</span><span class="p">(</span><span class="n">note_freq</span><span class="p">,</span> <span class="n">note_time</span><span class="p">,</span> <span class="mi">50u32</span><span class="p">,</span> <span class="mi">0u32</span><span class="p">)</span>
    <span class="n">s</span><span class="o">.</span><span class="n">cursor</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">cursor</span> <span class="o">&gt;</span> <span class="n">s</span><span class="o">.</span><span class="n">note_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">game_step</span><span class="p">(</span><span class="n">d</span><span class="p">:</span> <span class="n">AnyPtr</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">s</span><span class="p">:</span> <span class="n">State</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;State&quot;</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
    <span class="n">s</span><span class="o">.</span><span class="n">frame_count</span> <span class="o">+=</span> <span class="mi">1u64</span>
    <span class="n">handle_input</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="n">draw_board</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="n">draw_notes</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="n">play_notes</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">init_state</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">State</span><span class="p">:</span>
    <span class="n">s</span><span class="p">:</span> <span class="n">State</span> <span class="o">=</span> <span class="n">State</span><span class="p">()</span>
    <span class="n">s</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">160</span>
    <span class="n">s</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">160</span>
    <span class="n">s</span><span class="o">.</span><span class="n">frame_count</span> <span class="o">=</span> <span class="mi">0u64</span>
    <span class="n">s</span><span class="o">.</span><span class="n">play_on</span> <span class="o">=</span> <span class="mi">0u64</span>
    <span class="n">s</span><span class="o">.</span><span class="n">gamepad_prev</span> <span class="o">=</span> <span class="mi">0u8</span>
    <span class="n">s</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">s</span><span class="o">.</span><span class="n">note_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">s</span><span class="o">.</span><span class="n">v_start</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">s</span><span class="o">.</span><span class="n">v_end</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">s</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">MODE_NOTE</span>
    <span class="n">s</span><span class="o">.</span><span class="n">playing</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">s</span><span class="o">.</span><span class="n">note_freq</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="s2">&quot;int&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">262</span><span class="p">,</span><span class="mi">277</span><span class="p">,</span><span class="mi">294</span><span class="p">,</span><span class="mi">311</span><span class="p">,</span><span class="mi">330</span><span class="p">,</span><span class="mi">349</span><span class="p">,</span><span class="mi">370</span><span class="p">,</span><span class="mi">392</span><span class="p">,</span><span class="mi">415</span><span class="p">,</span><span class="mi">440</span><span class="p">,</span><span class="mi">466</span><span class="p">,</span><span class="mi">495</span><span class="p">,</span><span class="mi">523</span><span class="p">,</span><span class="mi">554</span><span class="p">,</span><span class="mi">587</span><span class="p">,</span><span class="mi">622</span><span class="p">,</span><span class="mi">659</span><span class="p">,</span><span class="mi">698</span><span class="p">,</span><span class="mi">740</span><span class="p">,</span><span class="mi">784</span><span class="p">,</span><span class="mi">830</span><span class="p">,</span><span class="mi">880</span><span class="p">,</span><span class="mi">932</span><span class="p">,</span><span class="mi">988</span><span class="p">,</span><span class="mi">1047</span><span class="p">,</span><span class="mi">1109</span><span class="p">,</span><span class="mi">1175</span><span class="p">,</span><span class="mi">1245</span><span class="p">,</span><span class="mi">1319</span><span class="p">,</span><span class="mi">1397</span><span class="p">,</span><span class="mi">1480</span><span class="p">,</span><span class="mi">1568</span><span class="p">,</span><span class="mi">1661</span><span class="p">,</span><span class="mi">1760</span><span class="p">,</span><span class="mi">1865</span><span class="p">,</span><span class="mi">1976</span><span class="p">)</span>
    <span class="n">s</span><span class="o">.</span><span class="n">note_time</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="s2">&quot;int&quot;</span><span class="p">,</span><span class="mi">60</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># 11 character buffer for writing stuff</span>
    <span class="n">s</span><span class="o">.</span><span class="n">text_buf</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;Array[u8]&quot;</span><span class="p">,</span> <span class="n">mini_clib</span><span class="o">.</span><span class="n">calloc</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="s2">&quot;mini_clib.Size&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;mini_clib.Size&quot;</span><span class="p">,</span> <span class="mi">11</span><span class="p">)))</span>
    <span class="c1"># Set total number of notes to max notes</span>
    <span class="n">arrsetlen</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">,</span> <span class="n">MAX_NOTES</span><span class="p">)</span>
    <span class="c1"># Mark it all as null</span>
    <span class="n">x</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">MAX_NOTES</span><span class="p">:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">NOTE_NULL</span>
        <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">NOTE_NULL</span>
        <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">NOTE_NULL</span>
        <span class="n">s</span><span class="o">.</span><span class="n">note_buf</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">NOTE_NULL</span>
        <span class="n">x</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">s</span>

<span class="k">def</span> <span class="nf">del_state</span><span class="p">(</span><span class="n">current</span><span class="p">:</span> <span class="n">AnyPtr</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">del</span> <span class="n">current</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="c1"># based on palette</span>
    <span class="c1"># https://lospec.com/palette-list/sweet-28</span>
    <span class="c1"># https://lospec.com/palette-list/bread-berry</span>
    <span class="n">w4</span><span class="o">.</span><span class="n">set_palette</span><span class="p">(</span><span class="mh">0xfff678</span><span class="nb">u32</span><span class="p">,</span> <span class="mh">0x1fa4bf</span><span class="nb">u32</span><span class="p">,</span> <span class="mh">0xda4fbc</span><span class="nb">u32</span><span class="p">,</span> <span class="mh">0x1b1b5c</span><span class="nb">u32</span><span class="p">)</span>
    <span class="n">s</span><span class="p">:</span> <span class="n">State</span> <span class="o">=</span> <span class="n">init_state</span><span class="p">()</span>
    <span class="n">w4</span><span class="o">.</span><span class="n">set_game_state</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="s2">&quot;AnyPtr&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span>
    <span class="k">return</span> <span class="mi">0</span>
</pre></div></details></div><div class="note"></div></div><div class="box"><div class="content"><a href="/static_demos/notes_wasm4/notes.html"target="_blank">Show demo in a new tab</a><details open><summary>Show demo inline</summary><iframe src="/static_demos/notes_wasm4/notes.html"width="100%"height="700px"style="border:none">&nbsp</iframe></details></div><div class="note"></div></div><div class="box"><div class="content"><hr></div><div class="note"><hr></div></div><div class="box"><div class="content"><h2 id="wasm4-demo-snake">WASM4 Demo - snake</h2><span class="timestamp">Created 2023-08-13, Last Updated 2023-08-13</span></div><div class="note"></div></div><div class="box"><div class="content"><p>Hint: Snake game in Yaksha for WASM4 (ported)</div><div class="note"></div></div><div class="box"><div class="content"><details open><summary>Code</summary><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">w4</span>
<span class="kn">import</span> <span class="nn">libs.random</span>

<span class="k">class</span> <span class="nc">Point</span><span class="p">:</span>
    <span class="c1"># Point (x, y)</span>
    <span class="n">x</span><span class="p">:</span> <span class="nb">i16</span>
    <span class="n">y</span><span class="p">:</span> <span class="nb">i16</span>

<span class="k">class</span> <span class="nc">Snake</span><span class="p">:</span>
    <span class="c1"># Snake&#39;s body and direction</span>
    <span class="n">body</span><span class="p">:</span> <span class="nb">Array</span><span class="p">[</span><span class="n">Point</span><span class="p">]</span>
    <span class="n">direction</span><span class="p">:</span> <span class="n">Point</span>

<span class="k">class</span> <span class="nc">State</span><span class="p">:</span>
    <span class="c1"># Game state</span>
    <span class="n">snake</span><span class="p">:</span> <span class="n">Snake</span>
    <span class="n">fruit_sprite</span><span class="p">:</span> <span class="nb">Ptr</span><span class="p">[</span><span class="nb">Const</span><span class="p">[</span><span class="nb">u8</span><span class="p">]]</span>
    <span class="n">fruit</span><span class="p">:</span> <span class="n">Point</span>
    <span class="n">frame_count</span><span class="p">:</span> <span class="nb">u32</span>
    <span class="n">gamepad_prev</span><span class="p">:</span> <span class="nb">u8</span>

<span class="k">def</span> <span class="nf">point</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nb">i16</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">i16</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Point</span><span class="p">:</span>
    <span class="n">my_point</span><span class="p">:</span> <span class="n">Point</span> <span class="o">=</span> <span class="n">Point</span><span class="p">()</span>
    <span class="n">my_point</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span>
    <span class="n">my_point</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span>
    <span class="k">return</span> <span class="n">my_point</span>

<span class="k">def</span> <span class="nf">set_random_point</span><span class="p">(</span><span class="n">p</span><span class="p">:</span> <span class="n">Point</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Point</span><span class="p">:</span>
    <span class="n">x</span><span class="p">:</span> <span class="nb">i16</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;i16&quot;</span><span class="p">,</span> <span class="n">random</span><span class="o">.</span><span class="n">random_u64</span><span class="p">()</span> <span class="o">%</span> <span class="mi">20u64</span><span class="p">)</span>
    <span class="n">y</span><span class="p">:</span> <span class="nb">i16</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;i16&quot;</span><span class="p">,</span> <span class="n">random</span><span class="o">.</span><span class="n">random_u64</span><span class="p">()</span> <span class="o">%</span> <span class="mi">20u64</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span>
    <span class="n">p</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span>

<span class="k">def</span> <span class="nf">random_point</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Point</span><span class="p">:</span>
    <span class="n">p</span><span class="p">:</span> <span class="n">Point</span> <span class="o">=</span> <span class="n">Point</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">set_random_point</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">draw_snake</span><span class="p">(</span><span class="n">snake</span><span class="p">:</span> <span class="n">Snake</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="c1"># Body</span>
    <span class="n">w4</span><span class="o">.</span><span class="n">set_draw_colors</span><span class="p">(</span><span class="mh">0x0043</span><span class="nb">u16</span><span class="p">)</span>
    <span class="n">i</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">snake</span><span class="o">.</span><span class="n">body</span><span class="p">):</span>
        <span class="n">body_part</span><span class="p">:</span> <span class="n">Point</span> <span class="o">=</span> <span class="n">snake</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">x</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;int&quot;</span><span class="p">,</span> <span class="n">body_part</span><span class="o">.</span><span class="n">x</span> <span class="o">*</span> <span class="mi">8i16</span><span class="p">)</span>
        <span class="n">y</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;int&quot;</span><span class="p">,</span> <span class="n">body_part</span><span class="o">.</span><span class="n">y</span> <span class="o">*</span> <span class="mi">8i16</span><span class="p">)</span>
        <span class="n">w4</span><span class="o">.</span><span class="n">rect</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">8u32</span><span class="p">,</span> <span class="mi">8u32</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="c1"># Head</span>
    <span class="n">w4</span><span class="o">.</span><span class="n">set_draw_colors</span><span class="p">(</span><span class="mh">0x0004</span><span class="nb">u16</span><span class="p">)</span>
    <span class="n">body_part</span><span class="p">:</span> <span class="n">Point</span> <span class="o">=</span> <span class="n">snake</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">x</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;int&quot;</span><span class="p">,</span> <span class="n">body_part</span><span class="o">.</span><span class="n">x</span> <span class="o">*</span> <span class="mi">8i16</span><span class="p">)</span>
    <span class="n">y</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;int&quot;</span><span class="p">,</span> <span class="n">body_part</span><span class="o">.</span><span class="n">y</span> <span class="o">*</span> <span class="mi">8i16</span><span class="p">)</span>
    <span class="n">w4</span><span class="o">.</span><span class="n">rect</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">8u32</span><span class="p">,</span> <span class="mi">8u32</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">snake_push</span><span class="p">(</span><span class="n">snake</span><span class="p">:</span> <span class="n">Snake</span><span class="p">,</span> <span class="n">p</span><span class="p">:</span> <span class="n">Point</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="nb">arrput</span><span class="p">(</span><span class="n">snake</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">snake_update</span><span class="p">(</span><span class="n">snake</span><span class="p">:</span> <span class="n">Snake</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="c1"># Move snake a level up</span>
    <span class="n">position</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">snake</span><span class="o">.</span><span class="n">body</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="n">position</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">snake</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="n">position</span><span class="p">]</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">snake</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="n">position</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
        <span class="n">snake</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="n">position</span><span class="p">]</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">snake</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="n">position</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">y</span>
        <span class="n">position</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="n">snake</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">snake</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">snake</span><span class="o">.</span><span class="n">direction</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="o">%</span> <span class="mi">20i16</span>
    <span class="n">snake</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">snake</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">snake</span><span class="o">.</span><span class="n">direction</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">%</span> <span class="mi">20i16</span>
    <span class="k">if</span> <span class="n">snake</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0i16</span><span class="p">:</span>
        <span class="n">snake</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">19i16</span>
    <span class="k">if</span> <span class="n">snake</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y</span> <span class="o">&lt;</span> <span class="mi">0i16</span><span class="p">:</span>
        <span class="n">snake</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="mi">19i16</span>

<span class="k">def</span> <span class="nf">snake_up</span><span class="p">(</span><span class="n">snake</span><span class="p">:</span> <span class="n">Snake</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">snake</span><span class="o">.</span><span class="n">direction</span><span class="o">.</span><span class="n">y</span> <span class="o">==</span> <span class="mi">0i16</span><span class="p">:</span>
        <span class="n">snake</span><span class="o">.</span><span class="n">direction</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0i16</span>
        <span class="n">snake</span><span class="o">.</span><span class="n">direction</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1i16</span>

<span class="k">def</span> <span class="nf">snake_down</span><span class="p">(</span><span class="n">snake</span><span class="p">:</span> <span class="n">Snake</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">snake</span><span class="o">.</span><span class="n">direction</span><span class="o">.</span><span class="n">y</span> <span class="o">==</span> <span class="mi">0i16</span><span class="p">:</span>
        <span class="n">snake</span><span class="o">.</span><span class="n">direction</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0i16</span>
        <span class="n">snake</span><span class="o">.</span><span class="n">direction</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="mi">1i16</span>

<span class="k">def</span> <span class="nf">snake_left</span><span class="p">(</span><span class="n">snake</span><span class="p">:</span> <span class="n">Snake</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">snake</span><span class="o">.</span><span class="n">direction</span><span class="o">.</span><span class="n">x</span> <span class="o">==</span> <span class="mi">0i16</span><span class="p">:</span>
        <span class="n">snake</span><span class="o">.</span><span class="n">direction</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1i16</span>
        <span class="n">snake</span><span class="o">.</span><span class="n">direction</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="mi">0i16</span>

<span class="k">def</span> <span class="nf">snake_right</span><span class="p">(</span><span class="n">snake</span><span class="p">:</span> <span class="n">Snake</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">snake</span><span class="o">.</span><span class="n">direction</span><span class="o">.</span><span class="n">x</span> <span class="o">==</span> <span class="mi">0i16</span><span class="p">:</span>
        <span class="n">snake</span><span class="o">.</span><span class="n">direction</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">1i16</span>
        <span class="n">snake</span><span class="o">.</span><span class="n">direction</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="mi">0i16</span>

<span class="k">def</span> <span class="nf">snake_isdead</span><span class="p">(</span><span class="n">snake</span><span class="p">:</span> <span class="n">Snake</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">part</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="n">part</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">snake</span><span class="o">.</span><span class="n">body</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">snake</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="n">part</span><span class="p">]</span><span class="o">.</span><span class="n">x</span> <span class="o">==</span> <span class="n">snake</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">x</span> <span class="ow">and</span> <span class="n">snake</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="n">part</span><span class="p">]</span><span class="o">.</span><span class="n">y</span> <span class="o">==</span> <span class="n">snake</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="n">part</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="kc">False</span>

<span class="k">def</span> <span class="nf">del_point</span><span class="p">(</span><span class="n">p</span><span class="p">:</span> <span class="n">Point</span><span class="p">,</span> <span class="n">ignored</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">del</span> <span class="n">p</span>
    <span class="k">return</span> <span class="kc">True</span>

<span class="k">def</span> <span class="nf">snake_reset</span><span class="p">(</span><span class="n">snake</span><span class="p">:</span> <span class="n">Snake</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">foreach</span><span class="p">(</span><span class="n">snake</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">del_point</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">snake</span><span class="o">.</span><span class="n">body</span>
    <span class="n">body</span><span class="p">:</span> <span class="nb">Array</span><span class="p">[</span><span class="n">Point</span><span class="p">]</span>
    <span class="nb">arrput</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">point</span><span class="p">(</span><span class="mi">2i16</span><span class="p">,</span> <span class="mi">0i16</span><span class="p">))</span>
    <span class="nb">arrput</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">point</span><span class="p">(</span><span class="mi">1i16</span><span class="p">,</span> <span class="mi">0i16</span><span class="p">))</span>
    <span class="nb">arrput</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">point</span><span class="p">(</span><span class="mi">0i16</span><span class="p">,</span> <span class="mi">0i16</span><span class="p">))</span>
    <span class="n">snake</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">body</span>
    <span class="n">snake</span><span class="o">.</span><span class="n">direction</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">1i16</span>
    <span class="n">snake</span><span class="o">.</span><span class="n">direction</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="mi">0i16</span>

<span class="k">def</span> <span class="nf">handle_input</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">just_pressed</span><span class="p">:</span> <span class="nb">u8</span> <span class="o">=</span> <span class="n">w4</span><span class="o">.</span><span class="n">gamepad1</span><span class="p">()</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">w4</span><span class="o">.</span><span class="n">gamepad1</span><span class="p">()</span> <span class="o">^</span> <span class="n">state</span><span class="o">.</span><span class="n">gamepad_prev</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">just_pressed</span> <span class="o">&amp;</span> <span class="n">w4</span><span class="o">.</span><span class="n">BUTTON_UP</span> <span class="o">!=</span> <span class="mi">0u8</span><span class="p">:</span>
        <span class="n">snake_up</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">snake</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">just_pressed</span> <span class="o">&amp;</span> <span class="n">w4</span><span class="o">.</span><span class="n">BUTTON_DOWN</span> <span class="o">!=</span> <span class="mi">0u8</span><span class="p">:</span>
        <span class="n">snake_down</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">snake</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">just_pressed</span> <span class="o">&amp;</span> <span class="n">w4</span><span class="o">.</span><span class="n">BUTTON_LEFT</span> <span class="o">!=</span> <span class="mi">0u8</span><span class="p">:</span>
        <span class="n">snake_left</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">snake</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">just_pressed</span> <span class="o">&amp;</span> <span class="n">w4</span><span class="o">.</span><span class="n">BUTTON_RIGHT</span> <span class="o">!=</span> <span class="mi">0u8</span><span class="p">:</span>
        <span class="n">snake_right</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">snake</span><span class="p">)</span>
    <span class="n">state</span><span class="o">.</span><span class="n">gamepad_prev</span> <span class="o">=</span> <span class="n">w4</span><span class="o">.</span><span class="n">gamepad1</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">game_step</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">AnyPtr</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">state</span><span class="p">:</span> <span class="n">State</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;State&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="n">state</span><span class="o">.</span><span class="n">frame_count</span> <span class="o">+=</span> <span class="mi">1u32</span>
    <span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="s2">&quot;u64&quot;</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">frame_count</span><span class="p">))</span>
    <span class="n">x</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;int&quot;</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">fruit</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
    <span class="n">y</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;int&quot;</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">fruit</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>

    <span class="n">handle_input</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">frame_count</span> <span class="o">%</span> <span class="mi">15u32</span> <span class="o">==</span> <span class="mi">0u32</span><span class="p">:</span>
        <span class="n">snake_update</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">snake</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">snake_isdead</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">snake</span><span class="p">):</span>
            <span class="n">snake_reset</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">snake</span><span class="p">)</span>
            <span class="n">state</span><span class="o">.</span><span class="n">fruit</span> <span class="o">=</span> <span class="n">set_random_point</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">fruit</span><span class="p">)</span>
        <span class="c1"># Ate fruit</span>
        <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">snake</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">x</span> <span class="o">==</span> <span class="n">state</span><span class="o">.</span><span class="n">fruit</span><span class="o">.</span><span class="n">x</span> <span class="ow">and</span> <span class="n">state</span><span class="o">.</span><span class="n">snake</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y</span> <span class="o">==</span> <span class="n">state</span><span class="o">.</span><span class="n">fruit</span><span class="o">.</span><span class="n">y</span><span class="p">:</span>
            <span class="n">penultimate</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">snake</span><span class="o">.</span><span class="n">body</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">snake_push</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">snake</span><span class="p">,</span> <span class="n">point</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">snake</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="n">penultimate</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">snake</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="n">penultimate</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">))</span>
            <span class="n">state</span><span class="o">.</span><span class="n">fruit</span> <span class="o">=</span> <span class="n">set_random_point</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">fruit</span><span class="p">)</span>

    <span class="n">draw_snake</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">snake</span><span class="p">)</span>
    <span class="c1"># Draw sprite</span>
    <span class="n">w4</span><span class="o">.</span><span class="n">set_draw_colors</span><span class="p">(</span><span class="mh">0x4320</span><span class="nb">u16</span><span class="p">)</span>
    <span class="n">w4</span><span class="o">.</span><span class="n">blit</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">fruit_sprite</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">8u32</span><span class="p">,</span> <span class="mi">8u32</span><span class="p">,</span> <span class="n">w4</span><span class="o">.</span><span class="n">BLIT_2BPP</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mh">0x20</span><span class="nb">u64</span><span class="p">)</span>
    <span class="n">w4</span><span class="o">.</span><span class="n">set_palette</span><span class="p">(</span><span class="mh">0xfbf7f3</span><span class="nb">u32</span><span class="p">,</span> <span class="mh">0xe5b083</span><span class="nb">u32</span><span class="p">,</span> <span class="mh">0x426e5d</span><span class="nb">u32</span><span class="p">,</span> <span class="mh">0x20283d</span><span class="nb">u32</span><span class="p">)</span>
    <span class="n">state</span><span class="p">:</span> <span class="n">State</span> <span class="o">=</span> <span class="n">State</span><span class="p">()</span>
    <span class="n">state</span><span class="o">.</span><span class="n">snake</span> <span class="o">=</span> <span class="n">Snake</span><span class="p">()</span>
    <span class="n">state</span><span class="o">.</span><span class="n">fruit</span> <span class="o">=</span> <span class="n">point</span><span class="p">(</span><span class="mi">10i16</span><span class="p">,</span> <span class="mi">8i16</span><span class="p">)</span>
    <span class="n">state</span><span class="o">.</span><span class="n">snake</span><span class="o">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">point</span><span class="p">(</span><span class="mi">1i16</span><span class="p">,</span> <span class="mi">0i16</span><span class="p">)</span>
    <span class="n">state</span><span class="o">.</span><span class="n">frame_count</span> <span class="o">=</span> <span class="mi">0u32</span>
    <span class="n">state</span><span class="o">.</span><span class="n">gamepad_prev</span> <span class="o">=</span> <span class="mi">0u8</span>
    <span class="n">body</span><span class="p">:</span> <span class="nb">Array</span><span class="p">[</span><span class="n">Point</span><span class="p">]</span>
    <span class="nb">arrput</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">point</span><span class="p">(</span><span class="mi">2i16</span><span class="p">,</span> <span class="mi">0i16</span><span class="p">))</span>
    <span class="nb">arrput</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">point</span><span class="p">(</span><span class="mi">1i16</span><span class="p">,</span> <span class="mi">0i16</span><span class="p">))</span>
    <span class="nb">arrput</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">point</span><span class="p">(</span><span class="mi">0i16</span><span class="p">,</span> <span class="mi">0i16</span><span class="p">))</span>
    <span class="n">state</span><span class="o">.</span><span class="n">snake</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">body</span>
    <span class="n">state</span><span class="o">.</span><span class="n">fruit_sprite</span> <span class="o">=</span> <span class="n">binarydata</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\x00\xa0\x02\x00\x0e\xf0\x36\x5c\xd6\x57\xd5\x57\x35\x5c\x0f\xf0</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">w4</span><span class="o">.</span><span class="n">set_game_state</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="s2">&quot;AnyPtr&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">))</span>
    <span class="k">return</span> <span class="mi">0</span>
</pre></div></details></div><div class="note"></div></div><div class="box"><div class="content"><a href="/static_demos/snake_wasm4/snake.html"target="_blank">Show demo in a new tab</a><details open><summary>Show demo inline</summary><iframe src="/static_demos/snake_wasm4/snake.html"width="100%"height="700px"style="border:none">&nbsp</iframe></details></div><div class="note"></div></div></div></div><script>!function(){const e=document.querySelector("#btn-toggle");var t=document.querySelector("#btn-small-font"),s=document.querySelector("#btn-medium-font"),n=document.querySelector("#btn-large-font");const a=document.querySelector("#theme-link"),l=document.querySelector("#font-size-link"),o="jadogg.github.io/theme",i="jadogg.github.io/font",c='<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-brightness-high" viewBox="0 0 16 16">\n  <path d="M8 11a3 3 0 1 1 0-6 3 3 0 0 1 0 6zm0 1a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"/>\n</svg>',r='<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-moon-fill" viewBox="0 0 16 16">\n  <path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"/>\n</svg>';var m=localStorage.getItem(o),g=localStorage.getItem(i);"/assets/style.min.css"!==m&&"/assets/style.light.min.css"!==m||(a.href=m,e.innerHTML="/assets/style.min.css"===m?c:r),"/assets/large-font.min.css"!=g&&"/assets/medium-font.min.css"!=g&&"/assets/small-font.min.css"!=g||(l.href=g),e.addEventListener("click",function(){"/assets/style.min.css"===a.getAttribute("href")?(a.href="/assets/style.light.min.css",localStorage.setItem(o,"/assets/style.light.min.css"),e.innerHTML=r):(a.href="/assets/style.min.css",localStorage.setItem(o,"/assets/style.min.css"),e.innerHTML=c)}),t.addEventListener("click",function(){l.href="/assets/small-font.min.css",localStorage.setItem(i,"/assets/small-font.min.css")}),s.addEventListener("click",function(){l.href="/assets/medium-font.min.css",localStorage.setItem(i,"/assets/medium-font.min.css")}),n.addEventListener("click",function(){l.href="/assets/large-font.min.css",localStorage.setItem(i,"/assets/large-font.min.css")}),document.body.querySelectorAll("details").forEach(e=>{e.hasAttribute("open")?e.removeAttribute("open"):e.setAttribute("open",!0),console.log(e.hasAttribute("open"))})}()</script>